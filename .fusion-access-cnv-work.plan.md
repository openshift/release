# Fusion Access CNV Integration Tests - Work Tracking Plan

## Summary

This branch implements comprehensive CNV (OpenShift Virtualization) integration tests for IBM Fusion Access Operator, validating that IBM Storage Scale shared storage can be provisioned and utilized by CNV-managed virtual machines. The work includes VM lifecycle operations, live migration, snapshot operations, and shared storage verification across OCP 4.20 and 4.21 with both standard interop and Component Readiness configurations.

## Work Context

**Branch**: `fusion-access-cnv-rebased`

**Commit**: `f2275b2bc90` - Add Fusion Access CNV integration tests with OCP 4.20/4.21 and Component Readiness support

**Fork**: `amp-rh/openshift-release`

### Primary JIRA Tickets

| Ticket | Summary | Status | Priority |
|--------|---------|--------|----------|
| [INTEROP-8481](https://issues.redhat.com/browse/INTEROP-8481) | Verify Fusion Access storage with CNV virtual machines | In Progress | Critical |
| [INTEROP-8520](https://issues.redhat.com/browse/INTEROP-8520) | Add additional CNV interoperability tests (VM stop, migrate, snapshot) | In Progress | Critical |
| [INTEROP-8612](https://issues.redhat.com/browse/INTEROP-8612) | Create OCP 4.21 config yaml files | In Progress | - |
| [INTEROP-8613](https://issues.redhat.com/browse/INTEROP-8613) | Migrate to Component Readiness Model | In Progress | - |

### Parent Epic

| Ticket | Summary | Status |
|--------|---------|--------|
| [INTEROP-8390](https://issues.redhat.com/browse/INTEROP-8390) | Storage Validation Testing - On Board Fusion Access Operator | In Progress |
| [INTEROP-8535](https://issues.redhat.com/browse/INTEROP-8535) | Migrate Single Product Interop Testing to Component Readiness Model | In Progress |

### GitHub

- **PR**: [#71891](https://github.com/openshift/release/pull/71891) (if exists, update link)
- **Compare**: https://github.com/openshift/release/compare/master...amp-rh:openshift-release:fusion-access-cnv-rebased

## Key Components

### Test Configurations

| File | OCP Version | Type | Schedule |
|------|-------------|------|----------|
| `RedHatQE-interop-testing-master__fusion-access-cnv-ocp4.20-lp-interop.yaml` | 4.20 | Standard | Disabled |
| `RedHatQE-interop-testing-master__fusion-access-cnv-ocp4.21-lp-interop.yaml` | 4.21 | Standard | Disabled |
| `RedHatQE-interop-testing-master__fusion-access-cnv-ocp4.20-lp-interop-cr.yaml` | 4.20 | Component Readiness | Twice daily |
| `RedHatQE-interop-testing-master__fusion-access-cnv-ocp4.21-lp-interop-cr.yaml` | 4.21 | Component Readiness | Twice daily |

### Step Registry Components

**Chain**:
- `interop-tests-fusion-access-cnv-test-chain` - Orchestrates all CNV integration tests

**Steps**:
| Step | Purpose | Test IDs |
|------|---------|----------|
| `interop-tests-fusion-access-create-shared-filesystem` | Create IBM Storage Scale filesystem for CNV | - |
| `interop-tests-fusion-access-configure-cnv-shared-storage` | Configure CNV to use Storage Scale storage class | - |
| `interop-tests-fusion-access-test-cnv-shared-storage` | Basic VM creation and storage validation | FA-CNV-1009, 1010 |
| `interop-tests-fusion-access-test-vm-lifecycle` | VM stop/restart operations | FA-CNV-1011, 1012 |
| `interop-tests-fusion-access-test-vm-migration` | VM live migration between nodes | FA-CNV-1022-1024 |
| `interop-tests-fusion-access-test-vm-snapshots` | VM snapshot create/restore/delete | FA-CNV-1025-1028 |
| `interop-tests-fusion-access-verify-shared-storage` | Cross-workload storage verification | - |

### Generated Prow Jobs

**Standard Interop**:
- `periodic-ci-RedHatQE-interop-testing-master-fusion-access-cnv-ocp4.20-lp-interop-fusion-access-cnv-ipi-ocp420`
- `periodic-ci-RedHatQE-interop-testing-master-fusion-access-cnv-ocp4.21-lp-interop-fusion-access-cnv-ipi-ocp421`

**Component Readiness**:
- `periodic-ci-RedHatQE-interop-testing-master-fusion-access-cnv-ocp4.20-lp-interop-cr-fusion-access-cnv-cr-ocp420`
- `periodic-ci-RedHatQE-interop-testing-master-fusion-access-cnv-ocp4.21-lp-interop-cr-fusion-access-cnv-cr-ocp421`

## Implementation Status

### ✅ Completed

1. **CNV Integration Tests** (INTEROP-8481, INTEROP-8520)
   - VM lifecycle operations (create, start, stop, restart)
   - VM live migration between worker nodes
   - VM snapshot operations (create, verify, restore, delete)
   - Shared storage verification (CNV ↔ Fusion Access)
   - JUnit XML test result reporting

2. **OCP 4.21 Support** (INTEROP-8612)
   - Created 4.21 standard interop config
   - Updated cli image and releases section
   - Updated Firewatch labels

3. **Component Readiness** (INTEROP-8613)
   - Created CR configs for both 4.20 and 4.21
   - Fixed OCP_VERSION override for 4.20 variant
   - Configured twice-daily cron schedule
   - Added REPORTPORTAL_CMP integration

4. **Code Quality**
   - Applied PR #67409 refactoring patterns
   - Implemented proper bash options (`set -eux -o pipefail; shopt -s inherit_errexit`)
   - Proper `oc wait` instead of sleep
   - Idempotent cleanup procedures

### ⏳ Pending

1. **PR Review & Merge**
   - Push branch to fork ✅
   - Open/update PR to openshift/release
   - Pass Prow rehearsal runs
   - Get PR approved
   - Merge

2. **JIRA Updates**
   - Update ticket status after merge
   - Close completed tickets

## Test Coverage Matrix

| Test ID | Description | Script | Status |
|---------|-------------|--------|--------|
| FA-CNV-1009 | VM Creation with shared storage | test-cnv-shared-storage | ✅ |
| FA-CNV-1010 | VM Start with shared storage | test-cnv-shared-storage | ✅ |
| FA-CNV-1011 | VM Stop with shared storage | test-vm-lifecycle | ✅ |
| FA-CNV-1012 | VM Restart with shared storage | test-vm-lifecycle | ✅ |
| FA-CNV-1022 | Migration environment preparation | test-vm-migration | ✅ |
| FA-CNV-1023 | Execute VM live migration | test-vm-migration | ✅ |
| FA-CNV-1024 | Verify migration results | test-vm-migration | ✅ |
| FA-CNV-1025 | Create VM snapshot | test-vm-snapshots | ✅ |
| FA-CNV-1026 | Verify VM snapshot exists | test-vm-snapshots | ✅ |
| FA-CNV-1027 | Restore VM from snapshot | test-vm-snapshots | ✅ |
| FA-CNV-1028 | Delete VM snapshot | test-vm-snapshots | ✅ |

**Coverage**: 100% of required tests (5/5 VM operations)

## Reference Documentation

- [OCP CI Step Registry Complete Guide](.cursor/rules/workflows/ocp-ci-step-registry-complete-guide.mdc)
- [OCP CI LP-Interop Test Patterns](.cursor/rules/workflows/ocp-ci-lp-interop-test-patterns.mdc)
- [Fusion Access Operator Complete Guide](.cursor/rules/specialized/fusion-access-operator-complete.mdc)
- [OCP CI JUnit XML Test Results Patterns](.cursor/rules/ocp-ci-junit-xml-test-results-patterns.mdc)

## Next Actions

1. [ ] Create/update PR at https://github.com/openshift/release
2. [ ] Monitor rehearsal runs for validation
3. [ ] Address any review feedback
4. [ ] After merge, update JIRA tickets to "Review" status
5. [ ] Verify periodic jobs appear in Prow dashboard

## Notes

- Branch was rebased and squashed to single commit for clean PR
- Component Readiness configs require OCP_VERSION override due to workflow default of 4.21
- All test scripts include JUnit XML output for CI integration
- IBM must-gather collection configured as post-step for debugging

