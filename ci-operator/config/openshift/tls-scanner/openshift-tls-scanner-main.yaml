base_images:
  base:
    name: "4.21"
    namespace: ocp
    tag: base-rhel9
  ocp_builder_rhel-9-golang-1.24-openshift-4.21:
    name: builder
    namespace: ocp
    tag: rhel-9-golang-1.24-openshift-4.21
build_root:
  image_stream_tag:
    name: builder
    namespace: ocp
    tag: rhel-9-golang-1.24-openshift-4.21
images:
- dockerfile_path: Dockerfile
  from: base
  inputs:
    ocp_builder_rhel-9-golang-1.24-openshift-4.21: {}
  to: tls-scanner-tool
promotion: {}
releases:
  initial:
    integration:
      name: "4.21"
      namespace: ocp
  latest:
    integration:
      include_built_images: true
      name: "4.21"
      namespace: ocp
resources:
  '*':
    requests:
      cpu: 100m
      memory: 200Mi
tests:
- as: run-scanner-on-cluster
  cluster_claim:
    architecture: amd64
    cloud: aws
    owner: openshift-ci
    product: ocp
    timeout: 1h0m0s
    version: "4.16"
  steps:
    test:
    - as: run-scanner
      cli: latest
      commands: |-
        set -o nounset
        set -o errexit
        set -o pipefail
        
        # 1. Setup environment variables for the deployment script
        export SCANNER_IMAGE="${PULL_SPEC_TLS_SCANNER_TOOL}"
        export NAMESPACE=tls-scanner-test
        oc create namespace "${NAMESPACE}"
        
        # Use a trap to ensure cleanup happens even if there are errors.
        trap './deploy.sh cleanup' EXIT
        
        # 2. Deploy the scanner Job to the ephemeral cluster
        ./deploy.sh deploy
        
        # 3. Add immediate debugging to check the state of the Job right after creation.
        echo "--- Checking Job status immediately after deployment ---"
        sleep 5 # Give the controllers a moment to react.
        oc describe job "tls-scanner-job" -n "${NAMESPACE}" || echo "Job description not available."
        echo "--- Checking for events in the namespace ---"
        oc get events -n "${NAMESPACE}" --sort-by='.metadata.creationTimestamp'
        echo "--- End of immediate debug ---"
        
        # 4. Wait for the Job to complete
        echo "Waiting for tls-scanner-job to complete in namespace ${NAMESPACE}..."
        if ! oc wait --for=condition=complete "job/tls-scanner-job" -n "${NAMESPACE}" --timeout=15m; then
          echo "Job did not complete in time. Gathering debug info..."
          # The pod might not have been created, so we need to handle that.
          POD_NAME=$(oc get pods -n "${NAMESPACE}" -l job-name=tls-scanner-job -o jsonpath='{.items[0].metadata.name}' || echo "pod-not-found")
          if [ "${POD_NAME}" != "pod-not-found" ]; then
            echo "--- Describing scanner job pod (${POD_NAME}) ---"
            oc describe pod "${POD_NAME}" -n "${NAMESPACE}"
            echo "--- Logs from scanner job pod (${POD_NAME}) ---"
            oc logs "${POD_NAME}" -n "${NAMESPACE}" --tail=-1
          else
            echo "Could not find a pod for the tls-scanner-job. Describing job for details:"
            oc describe job "tls-scanner-job" -n "${NAMESPACE}"
          fi
          exit 1
        fi
        
        # 5. Copy artifacts from the completed Pod to the CI artifact directory
        echo "Copying artifacts..."
        POD_NAME=$(oc get pods -n "${NAMESPACE}" -l job-name=tls-scanner-job -o jsonpath='{.items[0].metadata.name}')
        
        # Create a dedicated directory for the scanner's artifacts
        SCANNER_ARTIFACT_DIR="${ARTIFACT_DIR}/tls-scanner"
        mkdir -p "${SCANNER_ARTIFACT_DIR}"
        
        # Copy all files from the Pod's /artifacts/ directory
        oc cp "${NAMESPACE}/${POD_NAME}:/artifacts/." "${SCANNER_ARTIFACT_DIR}/"
        
        echo "Scan complete. Artifacts collected in ${SCANNER_ARTIFACT_DIR}."
        # The 'trap' will execute ./deploy.sh cleanup on exit.
      dependencies:
      - env: PULL_SPEC_TLS_SCANNER_TOOL
        name: tls-scanner-tool
      from: src
      grace_period: 1m0s
      resources:
        requests:
          cpu: 100m
    workflow: generic-claim
zz_generated_metadata:
  branch: main
  org: openshift
  repo: tls-scanner
