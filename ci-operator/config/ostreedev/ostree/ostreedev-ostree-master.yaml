base_images:
  f30:
    cluster: https://api.ci.openshift.org
    name: fedora
    namespace: rhcos
    tag: "30"

build_root:
  image_stream_tag:
    cluster: https://api.ci.openshift.org
    name: release
    namespace: openshift
    tag: golang-1.10

resources:
  '*':
    limits:
      memory: 6Gi
    requests:
      cpu: 1000m
      memory: 1Gi
  unit:
    limits:
      memory: 9Gi
    requests:
      cpu: '3'
      memory: 5Gi

raw_steps:
- pipeline_image_cache_step:
    commands: |
      cat <<DOCKERFILE > /opt/Dockerfile.sanity
      FROM ostree-ci
      RUN make install
      DOCKERFILE
    from: ostree-ci
    to: ostree-ci-dockerfile
- project_directory_image_build_step:
    from: ostree-ci
    inputs:
      ostree-ci-dockerfile:
        paths:
        - destination_dir: .
          source_path: ci/prow/Dockerfile.sanity
    to: ostree-ci-sanity

images:
- from: f30
  to: ostree-ci
  dockerfile_path: ci/prow/Dockerfile
- from: ostree-ci
  to: ostree-ci-sanity
  dockerfile_path: ci/prow/Dockerfile.sanity

# TODO move all these scripts to ci/prow
tests:
- as: sanity
  commands: ostree --version
  container:
    from: ostree-ci-sanity
# - as: minimal
#   commands: |
#     export CONFIGOPTS='--without-curl --without-soup --disable-gtk-doc --disable-man --disable-rust --without-libarchive --without-selinux --without-smack --without-openssl --without-avahi --without-libmount --disable-rofiles-fuse --disable-experimental-api'
#     make clean
#     ci/build.sh
#   container:
#     from: ostree-ci
# - as: primary
#   commands: |
#     export CFLAGS='-fsanitize=undefined -fsanitize-undefined-trap-on-error -fsanitize=address -O2 -Wp,-D_FORTIFY_SOURCE=2'
#     export GI_SCANNERFLAGS='--warn-error'
#     export ASAN_OPTIONS='detect_leaks=0'
#     export CONFIGOPTS='--with-curl --with-openssl'
#     make clean
#     ci/ci-commitmessage-submodules.sh
#     ci/build-check.sh
#     ci/ci-release-build.sh
#     make dist-then-build
#   container:
#     from: ostree-ci
# - as: rust
#   commands: |
#     export CONFIGOPTS='--enable-rust'
#     make clean
#     ci/build.sh
#     make check TESTS=tests/test-rollsum
#   container:
#     from: ostree-ci
# - as: gnutls
#   commands: |
#     export CONFIGOPTS='--with-crypto=gnutls'
#     make clean
#     ci/build.sh
#     make check TESTS=tests/test-basic.sh
#   container:
#     from: ostree-ci
# - as: libsoup
#   commands: |
#     export CONFIGOPTS='--without-curl --without-openssl --with-soup'
#     make clean
#     ci/build-check.sh
#   container:
#     from: ostree-ci
# - as: introspection
#   commands: |
#     export INSTALLED_TESTS_PATTERN='libostree/test-sizes.js libostree/test-sysroot.js libostree/test-core.js'
#     make clean
#     ci/build-check.sh
#   container:
#     from: ostree-ci
