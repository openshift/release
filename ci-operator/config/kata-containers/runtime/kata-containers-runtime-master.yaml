base_images:
  base:
    name: "4.6"
    namespace: ocp
    tag: base
binary_build_commands: .ci/openshift-ci/build.sh
build_root:
  image_stream_tag:
    name: release
    namespace: openshift
    tag: golang-1.13
images:
- context_dir: .ci/openshift-ci/images
  from: base
  inputs:
    bin:
      paths:
      - destination_dir: .
        source_path: /go/src/github.com/kata-containers/runtime/_out
  to: kata-installer
resources:
  '*':
    limits:
      memory: 4Gi
    requests:
      cpu: 100m
      memory: 200Mi
tag_specification:
  name: "4.6"
  namespace: ocp
tests:
- artifact_dir: /tmp/artifacts
  as: kata-containers-e2e-periodic
  cron: 2 7 * * *
  steps:
    cluster_profile: azure4
    test:
    - as: kata-containers-e2e-test
      cli: latest
      commands: |
        # oc is made available to this script via cli configuration, but
        # kubectl is not. Since kubectl is used by kata-webhook scripts,
        # thus it is created a symlink to oc.
        pushd "$CLI_DIR"
        if [ ! -f kubectl ]; then
        ln -s oc kubectl
        fi
        popd
        KATA_WORKDIR=/go/src/github.com/kata-containers/tests
        LOCAL_SHARED_DIR=${KATA_WORKDIR}/shared_dir
        mkdir -p $LOCAL_SHARED_DIR
        cd $KATA_WORKDIR
        # TODO: The ipi-azure test step does not export AZURE_AUTH_LOCATION
        # which causes openshift-tests to fail.
        export AZURE_AUTH_LOCATION=${SHARED_DIR}/metadata.json
        # The test script will clone the origin repository in order to build
        # the openshift-tests binary. However an origin (empty) folder can be
        # left behind when the current container image was created, so the
        # test script is going to fail.
        [ -d "/go/src/github.com/openshift/origin" ] && rm -rf "/go/src/github.com/openshift/origin"
        # To build the openshift-tests binary it is required Go 1.14.4 or greater.
        curl -OL https://storage.googleapis.com/golang/go1.14.4.linux-amd64.tar.gz
        tar -C $LOCAL_SHARED_DIR -xzf go1.14.4.linux-amd64.tar.gz
        export PATH=${LOCAL_SHARED_DIR}/go/bin:$PATH
        export GOROOT=${LOCAL_SHARED_DIR}/go
        # Overwrite the default tests directories otherwise it will use /var and
        # end up failing (read-only directory).
        export KATA_TESTS_BASEDIR="${KATA_WORKDIR}/_output/tests"
        .ci/openshift-ci/test.sh
      from: pipeline:bin
      resources:
        requests:
          cpu: 100m
          memory: 200Mi
    workflow: ipi-azure
zz_generated_metadata:
  branch: master
  org: kata-containers
  repo: runtime
