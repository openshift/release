build_root:
  project_image:
    dockerfile_literal: |
      FROM quay.io/multi-arch/yq:4.30.5 as yq4
      FROM quay.io/openshift-kni/ztp-site-generator:4.20.0 AS ztp-gen
      WORKDIR /home/ztp
      FROM quay-proxy.ci.openshift.org/openshift/ci:ci_telco-runner_latest
      COPY --from=yq4 /usr/bin/yq /usr/bin/yq
      COPY --from=ztp-gen /home/ztp /output/ztp
      RUN \
        curl -fsSL -o /tmp/get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 && \
        chmod 700 /tmp/get_helm.sh && \
        /tmp/get_helm.sh && \
        rm -f /tmp/get_helm.sh && \
        pip3 install --no-cache-dir "pytest==8.2.2" "pytest-shell==0.3.2" "requests[socks]==2.32.3"
releases:
  latest:
    candidate:
      product: ocp
      stream: nightly
      version: "4.20"
resources:
  '*':
    limits:
      memory: 4Gi
    requests:
      cpu: 100m
      memory: 200Mi
tests:
- as: telcov10n-metal-single-node-spoke
  capabilities:
  - intranet
  cron: 0 22 31 2 5
  steps:
    cluster_profile: equinix-ocp-metal-qe
    env:
      ADDITIONAL_WORKER_ARCHITECTURE: x86_64
      ADDITIONAL_WORKERS: "0"
      AUX_HOST: openshift-qe-metal-ci.arm.eng.rdu2.redhat.com
      CATALOGSOURCE_DISPLAY_NAME: Red Hat Custom Operators Catalog for 4.20
      DISCONNECTED: "false"
      DU_PROFILE: v4.20
      GITEA_NAMESPACE: ztp-gitea
      IMAGE_INDEX_OCP_VERSION: "4.20"
      MCH_NAMESPACE: open-cluster-management
      RESERVE_BOOTSTRAP: "false"
      SHARED_HUB_CLUSTER_PROFILE: ztp-hub-preserved-prod-cluster_profile_dir
      architecture: amd64
      ipv4_enabled: "true"
      ipv6_enabled: "false"
      masters: "1"
      workers: "0"
    test:
    - ref: telcov10n-metal-single-node-spoke-tests
    - ref: telcov10n-jiras
    workflow: telcov10n-metal-single-node-spoke
- as: telcov10n-metal-single-node-spoke-kpis
  capabilities:
  - intranet
  cron: 0 22 31 2 5
  steps:
    cluster_profile: equinix-ocp-metal-qe
    env:
      AUX_HOST: 10.6.157.20
      BIOS_SETTINGS: |-
        ---
        WorkloadProfile: TelcoOptimizedProfile
      BIOS_VALIDATIONS: |-
        ---
        # Settings are based on https://docs.openshift.com/container-platform/4.17/edge_computing/ztp-reference-cluster-configuration-for-vdu.html
        # Additional settings taken from https://access.redhat.com/articles/7032040
        CpuInterconnectBusLinkPower: Disabled # Uncore Frequency Scaling
        EnergyEfficientTurbo: Disabled
        EnergyPerformanceBias: MaxPower
        LogicalProc: Enabled # Enabel Hyper-Threading (SMT)
        PackageCStates: Disabled # Enable or Disable C0/C1 state
        ProcAvxP1: Level2
        ProcC1E: Disabled # Disable C1E state
        ProcCStates: Enabled # Performance P-limit; Enabled - OS controlled
        ProcPwrPerf: SysDbpmTelco # CPU Power and Performance Policy
        ProcTurboMode: Enabled # Enable turbo boost
        SecureBoot: Disabled # TODO: SecureBoot is disabled on this setup - starting OCP 4.17 it's required, unless it interferes with sideloading kernel
        SecureBootMode: DeployedMode
        SecureBootPolicy: Standard
        SriovGlobalEnable: Enabled
        SubNumaCluster: Disabled
        UncoreFrequency: MaxUFS # Uncore Frequency
      CATALOGSOURCE_DISPLAY_NAME: Red Hat Custom Operators Catalog for 4.20
      DU_PROFILE: v4.20
      GITEA_NAMESPACE: ztp-gitea
      IMAGE_INDEX_OCP_VERSION: "4.20"
      INTERNAL_NET_CIDR: 10.6.157.0/24
      MCH_NAMESPACE: open-cluster-management
      PG_RELATED_FILES: |-
        - filename: kustomization.yaml
          content: |-
            generators:
            - common-ranGen.yaml
            - group-du-sno-ranGen.yaml
            - group-du-sno-validator-ranGen.yaml
            - spree-03.yaml
            resources:
            - ns.yaml
        - filename: ns.yaml
          content: |-
            apiVersion: v1
            kind: Namespace
            metadata:
              name: ztp-common
            ---
            apiVersion: cluster.open-cluster-management.io/v1beta2
            kind: ManagedClusterSetBinding
            metadata:
              name: global
              namespace: ztp-common
            spec:
              clusterSet: global
            ---
            apiVersion: v1
            kind: Namespace
            metadata:
              name: ztp-group
            ---
            apiVersion: cluster.open-cluster-management.io/v1beta2
            kind: ManagedClusterSetBinding
            metadata:
              name: global
              namespace: ztp-group
            spec:
              clusterSet: global
            ---
            apiVersion: v1
            kind: Namespace
            metadata:
              name: ztp-site
            ---
            apiVersion: cluster.open-cluster-management.io/v1beta2
            kind: ManagedClusterSetBinding
            metadata:
              name: global
              namespace: ztp-site
            spec:
              clusterSet: global
        - filename: common-ranGen.yaml
          content: |-
            ---
            apiVersion: policy.open-cluster-management.io/v1
            kind: PolicyGenerator
            metadata:
              name: common
            placementBindingDefaults:
              name: common-placement-binding
            policyDefaults:
              namespace: ztp-common
              placement:
                labelSelector:
                  matchExpressions:
                    - key: common
                      operator: In
                      values:
                        - "true"
            policies:
              - name: common-config-policy
                policyAnnotations:
                  ran.openshift.io/ztp-deploy-wave: "1"
                manifests:
                  - path: source-crs/OperatorHub.yaml
                    patches:
                      - spec:
                          sources:
                            - disabled: true
                              name: community-operators
                            - disabled: false
                              name: certified-operators
                            - disabled: true
                              name: redhat-operators
                            - disabled: true
                              name: redhat-marketplace
                  - path: source-crs/DefaultCatsrc.yaml
                    patches:
                      - metadata:
                          name: redhat-operators-custom-4-20
                        spec:
                          displayName: Red Hat Custom Operators Catalog for 4.20
                          image: registry.redhat.io/redhat/redhat-operator-index:v4.20
              - name: common-subscriptions-policy
                policyAnnotations:
                  ran.openshift.io/ztp-deploy-wave: "2"
                manifests:
                  - path: source-crs/SriovSubscriptionNS.yaml
                  - path: source-crs/SriovSubscriptionOperGroup.yaml
                  - path: source-crs/SriovSubscription.yaml
                    patches:
                      - spec:
                          source: redhat-operators-custom-4-20
                  - path: source-crs/SriovOperatorStatus.yaml
                  - path: source-crs/AcceleratorsNS.yaml
                  - path: source-crs/AcceleratorsOperGroup.yaml
                  - path: source-crs/AcceleratorsSubscription.yaml
                    patches:
                      - spec:
                          source: certified-operators
                  - path: source-crs/PtpSubscriptionNS.yaml
                  - path: source-crs/PtpSubscriptionOperGroup.yaml
                  - path: source-crs/PtpSubscription.yaml
                    patches:
                      - spec:
                          source: redhat-operators-custom-4-20
                  - path: source-crs/PtpOperatorStatus.yaml
                  - path: source-crs/ClusterLogNS.yaml
                  - path: source-crs/ClusterLogOperGroup.yaml
                  - path: source-crs/ClusterLogSubscription.yaml
                    patches:
                      - spec:
                          source: redhat-operators-custom-4-20
                          channel: ""
                  - path: source-crs/ClusterLogOperatorStatus.yaml
                  - path: source-crs/ClusterLogServiceAccount.yaml
                  - path: source-crs/ClusterLogServiceAccountAuditBinding.yaml
                  - path: source-crs/ClusterLogServiceAccountInfrastructureBinding.yaml
                  - path: source-crs/StorageNS.yaml
                  - path: source-crs/StorageOperGroup.yaml
                  - path: source-crs/StorageSubscription.yaml
                    patches:
                      - spec:
                          source: redhat-operators-custom-4-20
                  - path: source-crs/StorageOperatorStatus.yaml
        - filename: group-du-sno-ranGen.yaml
          content: |-
            ---
            apiVersion: policy.open-cluster-management.io/v1
            kind: PolicyGenerator
            metadata:
              name: group-du-sno
            placementBindingDefaults:
              name: group-du-sno-placement-binding
            policyDefaults:
              namespace: ztp-group
              placement:
                labelSelector:
                  matchExpressions:
                    - key: group-du-sno
                      operator: Exists
            policies:
              - name: group-du-sno-config-policy
                policyAnnotations:
                  ran.openshift.io/ztp-deploy-wave: "10"
                manifests:
                  - path: source-crs/StorageLV.yaml
                    patches:
                      - metadata:
                          name: local-disks
                        spec:
                          storageClassDevices:
                            - storageClassName: general
                              devicePaths:
                                - /dev/disk/by-path/pci-0000:45:00.0-nvme-1
                  - path: source-crs/DisableOLMPprof.yaml
                  - path: source-crs/ClusterLogForwarder.yaml
                    patches:
                      - spec:
                          outputs:
                            - type: "kafka"
                              name: kafka-open
                              kafka:
                                url: "tcp://vran-qe-kafka.kni-qe-11.lab.eng.rdu2.redhat.com:9092/vran-qe"
                          filters:
                            - name: test-labels
                              type: openshiftLabels
                              openshiftLabels:
                                label1: test1
                                label2: test2
                                label3: test3
                                label4: test4
                          pipelines:
                            - name: all-to-default
                              inputRefs:
                                - audit
                                - infrastructure
                              filterRefs:
                                - test-labels
                              outputRefs:
                                - kafka-open
                  - path: source-crs/PtpOperatorConfig.yaml
                    patches:
                      - spec:
                          daemonNodeSelector:
                            $patch: replace
                            node-role.kubernetes.io/worker: ""
                  - path: source-crs/PtpConfigSlaveForEvent.yaml
                    patches:
                      - spec:
                          profile:
                            - name: "slave"
                              interface: "ens2f0"
                              ptpSettings:
                                logReduce: "false"
                          recommend:
                            - profile: "slave"
                              priority: 4
                              match:
                                - nodeLabel: node-role.kubernetes.io/worker
                    openapi:
                      path: schema.openapi
                  - path: source-crs/SriovOperatorConfigForSNO.yaml
                    complianceType: musthave
                    patches:
                      - spec:
                          configDaemonNodeSelector:
                            $patch: replace
                            node-role.kubernetes.io/master: ""
                  - path: source-crs/DisableSnoNetworkDiag.yaml
                  - path: source-crs/PerformanceProfile.yaml
                    patches:
                      - spec:
                          cpu:
                            isolated: "2-31,34-63"
                            reserved: "0-1,32-33"
                          hugepages:
                            defaultHugepagesSize: 1G
                            pages:
                              - size: 1G
                                count: 32
                          machineConfigPoolSelector:
                            $patch: replace
                            pools.operator.machineconfiguration.openshift.io/master: ""
                          nodeSelector:
                            $patch: replace
                            node-role.kubernetes.io/master: ""
                          realTimeKernel:
                            enabled: true
                          workloadHints:
                            realTime: true
                            highPowerConsumption: false
                            perPodPowerManagement: false
                  - path: source-crs/TunedPerformancePatch.yaml
        - filename: group-du-sno-validator-ranGen.yaml
          content: |-
            apiVersion: policy.open-cluster-management.io/v1
            kind: PolicyGenerator
            metadata:
              name: group-du-sno-validator
            placementBindingDefaults:
              name: group-du-sno-validator-placement-binding
            policyDefaults:
              namespace: ztp-group
              placement:
                labelSelector:
                  matchExpressions:
                    - key: group-du-sno
                      operator: Exists
                    - key: ztp-done
                      operator: DoesNotExist
            policies:
              - name: group-du-sno-validator-du-policy
                policyAnnotations:
                  ran.openshift.io/ztp-deploy-wave: "10000"
                remediationAction: inform
                manifests:
                  - path: source-crs/validatorCRs/informDuValidatorMaster.yaml
        - filename: spree-03.yaml
          content: |-
            ---
            apiVersion: policy.open-cluster-management.io/v1
            kind: PolicyGenerator
            metadata:
              name: spree-03
            placementBindingDefaults:
              name: spree-03-placement-binding
            policyDefaults:
              namespace: ztp-site
              placement:
                labelSelector:
                  matchExpressions:
                    - key: group-du-sno
                      operator: Exists
            policies:
              - name: spree-03-config-policy
                policyAnnotations:
                  ran.openshift.io/ztp-deploy-wave: "10"
                manifests:
                  - path: source-crs/SriovNetwork.yaml
                    patches:
                      - metadata:
                          name: "sriov-nw-du-fh"
                        spec:
                          resourceName: du_fh
                          vlan: 140
                  - path: source-crs/SriovNetworkNodePolicy.yaml
                    patches:
                      - metadata:
                          name: "sriov-nnp-du-fh"
                        spec:
                          deviceType: vfio-pci
                          isRdma: false
                          nicSelector:
                            pfNames: []
                            rootDevices:
                              - 0000:ca:00.2
                            vendor: "8086"
                            deviceID: "1593"
                          numVfs: 8
                          priority: 10
                          resourceName: du_fh
                    openapi:
                      path: schema.openapi
                  - path: source-crs/SriovNetwork.yaml
                    patches:
                      - metadata:
                          name: "sriov-nw-du-mh"
                        spec:
                          resourceName: du_mh
                          vlan: 150
                  - path: source-crs/SriovNetworkNodePolicy.yaml
                    patches:
                      - metadata:
                          name: "sriov-nnp-du-mh"
                        spec:
                          deviceType: vfio-pci
                          isRdma: false
                          nicSelector:
                            pfNames: []
                            rootDevices:
                              - 0000:ca:00.3
                            vendor: "8086"
                            deviceID: "1593"
                          numVfs: 8
                          priority: 10
                          resourceName: du_mh
                    openapi:
                      path: schema.openapi
        - filename: schema.openapi
          content: |-
            {
              "definitions": {
                "io.openshift.ptp.v1.PtpConfig": {
                  "description": "PtpConfig is the Schema for the ptpconfigs API",
                  "properties": {
                    "apiVersion": {
                      "description": "APIVersion defines the versioned schema of this representation of an object.",
                      "type": "string"
                    },
                    "kind": {
                      "description": "Kind is a string value representing the REST resource this object represents.",
                      "type": "string"
                    },
                    "metadata": {
                      "$ref": "#/definitions/io.k8s.apimachinery.pkg.apis.meta.v1.ObjectMeta_v2",
                      "description": "Standard object's metadata."
                    },
                    "spec": {
                      "description": "PtpConfigSpec defines the desired state of PtpConfig",
                      "properties": {
                        "profile": {
                          "x-kubernetes-patch-merge-key": "name",
                          "x-kubernetes-patch-strategy": "merge",
                          "items": {
                            "properties": {
                              "interface": { "type": "string" },
                              "name": { "type": "string" },
                              "phc2sysConf": { "type": "string" },
                              "phc2sysOpts": { "type": "string" },
                              "plugins": {
                                "additionalProperties": { "x-kubernetes-preserve-unknown-fields": true },
                                "type": "object"
                              },
                              "ptp4lConf": { "type": "string" },
                              "ptp4lOpts": { "type": "string" },
                              "ptpClockThreshold": {
                                "properties": {
                                  "holdOverTimeout": { "description": "clock state to stay in holdover state in secs", "format": "int64", "type": "integer" },
                                  "maxOffsetThreshold": { "description": "max offset in nano secs", "format": "int64", "type": "integer" },
                                  "minOffsetThreshold": { "description": "min offset in nano secs", "format": "int64", "type": "integer" }
                                },
                                "type": "object"
                              },
                              "ptpSchedulingPolicy": { "enum": ["SCHED_OTHER", "SCHED_FIFO"], "type": "string" },
                              "ptpSchedulingPriority": { "format": "int64", "maximum": 65, "minimum": 1, "type": "integer" },
                              "ptpSettings": { "additionalProperties": { "type": "string" }, "type": "object" },
                              "ts2phcConf": { "type": "string" },
                              "ts2phcOpts": { "type": "string" }
                            },
                            "required": ["name"],
                            "type": "object"
                          },
                          "type": "array"
                        },
                        "recommend": {
                          "x-kubernetes-patch-merge-key": "profile",
                          "x-kubernetes-patch-strategy": "merge",
                          "items": {
                            "properties": {
                              "match": {
                                "items": {
                                  "x-kubernetes-patch-merge-key": "nodeName",
                                  "x-kubernetes-patch-strategy": "merge",
                                  "properties": {
                                    "nodeLabel": { "type": "string" },
                                    "nodeName": { "type": "string" }
                                  },
                                  "type": "object"
                                },
                                "type": "array"
                              },
                              "priority": { "format": "int64", "type": "integer" },
                              "profile": { "type": "string" }
                            },
                            "required": ["priority", "profile"],
                            "type": "object"
                          },
                          "type": "array"
                        }
                      },
                      "required": ["profile", "recommend"],
                      "type": "object"
                    },
                    "status": {
                      "description": "PtpConfigStatus defines the observed state of PtpConfig",
                      "properties": {
                        "matchList": {
                          "description": "INSERT ADDITIONAL STATUS FIELD - define observed state of cluster",
                          "x-kubernetes-patch-merge-key": "nodeName",
                          "x-kubernetes-patch-strategy": "merge",
                          "items": {
                            "properties": {
                              "nodeName": { "type": "string" },
                              "profile": { "type": "string" }
                            },
                            "required": ["nodeName", "profile"],
                            "type": "object"
                          },
                          "type": "array"
                        }
                      },
                      "type": "object"
                    }
                  },
                  "type": "object",
                  "x-kubernetes-group-version-kind": [{ "group": "ptp.openshift.io", "kind": "PtpConfig", "version": "v1" }]
                },
                "io.openshift.observability.v1.ClusterLogForwarder": {
                  "properties": {
                    "spec": {
                      "properties": {
                        "filters": { "x-kubernetes-patch-merge-key": "name", "x-kubernetes-patch-strategy": "merge", "type": "array" },
                        "outputs": { "x-kubernetes-patch-merge-key": "name", "x-kubernetes-patch-strategy": "merge", "type": "array" }
                      },
                      "type": "object"
                    }
                  },
                  "type": "object",
                  "x-kubernetes-group-version-kind": [{ "group": "observability.openshift.io", "kind": "ClusterLogForwarder", "version": "v1" }]
                },
                "io.openshift.sriovnetwork.v1.SriovNetworkNodePolicy": {
                  "description": "SriovNetworkNodePolicy schema",
                  "properties": {
                    "spec": {
                      "properties": {
                        "deviceType": { "type": "string" },
                        "isRdma": { "type": "boolean" },
                        "nicSelector": {
                          "properties": {
                            "pfNames": { "items": { "type": "string" }, "type": "array" },
                            "rootDevices": { "items": { "type": "string" }, "type": "array" },
                            "vendor": { "type": "string" },
                            "deviceID": { "type": "string" }
                          },
                          "type": "object"
                        },
                        "numVfs": { "type": "integer" },
                        "priority": { "type": "integer" },
                        "resourceName": { "type": "string" }
                      },
                      "type": "object"
                    }
                  },
                  "type": "object"
                }
              }
            }
      SHARED_HUB_CLUSTER_PROFILE: ztp-hub-preserved-prod-cluster_profile_dir
      SOCKS5_PROXY: socks5h://10.6.157.20:3124
    test:
    - ref: telcov10n-metal-single-node-spoke-kpis-tests-telco-operators
    - ref: telcov10n-metal-single-node-spoke-kpis-tests-oslat
    - ref: telcov10n-metal-single-node-spoke-kpis-tests-cpu-util
    - ref: telcov10n-metal-single-node-spoke-kpis-tests-ptp-reporting
    workflow: telcov10n-metal-single-node-spoke-kpis
zz_generated_metadata:
  branch: main
  org: openshift-kni
  repo: eco-ci-cd
  variant: nightly-4.20
