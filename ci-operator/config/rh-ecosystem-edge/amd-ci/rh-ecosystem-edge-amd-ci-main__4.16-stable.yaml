build_root:
  image_stream_tag:
    name: release
    namespace: openshift
    tag: golang-1.18
images:
- dockerfile_path: Containerfile
  to: amd-ci
resources:
  '*':
    limits:
      memory: 4Gi
    requests:
      cpu: 100m
      memory: 200Mi
tests:
- always_run: false
  as: e2e-amd-ci
  capabilities:
  - intranet
  restrict_network_access: false
  steps:
    env:
      OCP_CLUSTER_VERSION: "4.16"
      REMOTE_HOST: 10.1.178.14
    post:
    - as: e2e-amd-ci-post
      commands: |
        cp /var/run/amd-ci/id_rsa /tmp/id_rsa
        chmod 600 /tmp/id_rsa
        mkdir -p ~/.ssh

        # Create SSH config matching working local setup
        cat > ~/.ssh/config <<'SSH_CONFIG'
        Host ${REMOTE_HOST}
            User root
            IdentityFile /tmp/id_rsa
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
            ConnectTimeout 30
            ServerAliveInterval 10
            ServerAliveCountMax 3
            BatchMode yes
        SSH_CONFIG
        sed -i "s/\${REMOTE_HOST}/${REMOTE_HOST}/g" ~/.ssh/config
        chmod 600 ~/.ssh/config

        export PULL_SECRET_PATH=/var/run/amd-ci/pull-secret
        export SSH_KEY_PATH=/tmp/id_rsa
        make sno-delete
      credentials:
      - collection: ""
        mount_path: /var/run/amd-ci
        name: amd-ci-credentials
        namespace: test-credentials
      env:
      - default: /alabama
        name: HOME
      - name: OCP_CLUSTER_VERSION
      - name: REMOTE_HOST
      from: amd-ci
      resources:
        requests:
          cpu: 2000m
          memory: 2Gi
    pre:
    - as: e2e-amd-ci-pre
      commands: |
        set -x
        cp /var/run/amd-ci/id_rsa /tmp/id_rsa
        chmod 600 /tmp/id_rsa
        mkdir -p ~/.ssh
        echo "Host ${REMOTE_HOST}" > ~/.ssh/config
        echo "  User root" >> ~/.ssh/config
        echo "  IdentityFile /tmp/id_rsa" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config
        echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
        chmod 600 ~/.ssh/config
        ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@${REMOTE_HOST} "echo 'Host *' >> /etc/ssh/ssh_config && echo '  StrictHostKeyChecking no' >> /etc/ssh/ssh_config && echo '  UserKnownHostsFile /dev/null' >> /etc/ssh/ssh_config && echo '#!/bin/sh' > /bin/sudo && echo 'exec \"\$@\"' >> /bin/sudo && chmod 755 /bin/sudo"
        scp -i /tmp/id_rsa -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null /tmp/id_rsa root@${REMOTE_HOST}:~/.ssh/id_rsa
        ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@${REMOTE_HOST} "chmod 600 ~/.ssh/id_rsa && ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub && chmod 600 ~/.ssh/authorized_keys 2>/dev/null || true && grep -qF \"\$(cat ~/.ssh/id_rsa.pub)\" ~/.ssh/authorized_keys 2>/dev/null || cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys"
        export PULL_SECRET_PATH=/var/run/amd-ci/pull-secret
        export SSH_KEY_PATH=/tmp/id_rsa
        make sno-deploy
      credentials:
      - collection: ""
        mount_path: /var/run/amd-ci
        name: amd-ci-credentials
        namespace: test-credentials
      env:
      - default: /alabama
        name: HOME
      - name: OCP_CLUSTER_VERSION
      - name: REMOTE_HOST
      from: amd-ci
      resources:
        requests:
          cpu: 2000m
          memory: 2Gi
    test:
    - as: e2e-amd-ci-test
      commands: |
        cp /var/run/amd-ci/id_rsa /tmp/id_rsa
        chmod 600 /tmp/id_rsa
        mkdir -p ~/.ssh
        echo "Host ${REMOTE_HOST}" > ~/.ssh/config
        echo "  User root" >> ~/.ssh/config
        echo "  IdentityFile /tmp/id_rsa" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config
        echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
        chmod 600 ~/.ssh/config
        echo "Waiting for cluster API to be ready on remote host..."
        for i in {1..60}; do
          if ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@${REMOTE_HOST} "curl -k -s --connect-timeout 5 https://192.168.122.253:6443/readyz" | grep -q "ok"; then
            echo "Cluster API is ready!"
            break
          fi
          echo "Waiting for API... ($i/60)"
          sleep 10
        done
        scp -i /tmp/id_rsa -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@${REMOTE_HOST}:/root/kubeconfig /tmp/kubeconfig
        sed -i 's|https://192.168.122.253:6443|https://127.0.0.1:6443|g' /tmp/kubeconfig
        sed -i 's|https://api.sno.example.com:6443|https://127.0.0.1:6443|g' /tmp/kubeconfig
        sed -i '/certificate-authority-data:/d' /tmp/kubeconfig
        sed -i '/server: https:\/\/127.0.0.1:6443/a\    insecure-skip-tls-verify: true' /tmp/kubeconfig
        ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -o ExitOnForwardFailure=yes -L 6443:192.168.122.253:6443 root@${REMOTE_HOST} -N -f
        sleep 5
        export KUBECONFIG=/tmp/kubeconfig
        oc get nodes
        oc get clusterversion
      credentials:
      - collection: ""
        mount_path: /var/run/amd-ci
        name: amd-ci-credentials
        namespace: test-credentials
      env:
      - default: /alabama
        name: HOME
      - name: OCP_CLUSTER_VERSION
      - name: REMOTE_HOST
      from: amd-ci
      resources:
        requests:
          cpu: 2000m
          memory: 2Gi
zz_generated_metadata:
  branch: main
  org: rh-ecosystem-edge
  repo: amd-ci
  variant: 4.16-stable
