build_root:
  project_image:
    dockerfile_literal: |-
      FROM registry.access.redhat.com/ubi9/go-toolset:1.24
      USER 0
      RUN yum install -y --nodocs --allowerasing jq
      RUN curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
      RUN mv kustomize /usr/local/bin/
      RUN yum clean all && rm -rf /var/cache/yum
      RUN ln -s /cli/oc /usr/bin/kubectl
      RUN ln -s /usr/bin/python3 /usr/bin/python
images:
- context_dir: maas-api/
  dockerfile_path: Dockerfile
  to: maas-api
promotion:
  to:
  - namespace: opendatahub-io
    tag: latest
releases:
  latest:
    release:
      architecture: multi
      channel: stable
      version: "4.19"
resources:
  '*':
    limits:
      memory: 4Gi
    requests:
      cpu: 100m
      memory: 200Mi
tests:
- always_run: false
  as: e2e-test-maas-api
  skip_if_only_changed: ^docs/|\.md$|^(?:.*/)?(?:\.gitignore|OWNERS|PROJECT|LICENSE)$|^\.github/
  steps:
    cluster_profile: aws-opendatahub
    env:
      BASE_DOMAIN: openshift-ci-aws.rhaiseng.com
      HYPERSHIFT_AWS_REGION: us-west-2
      HYPERSHIFT_NODE_COUNT: "1"
    post:
    - as: e2e-maas-api-openshift
      best_effort: true
      cli: latest
      commands: |-
        echo "Testing Token"
        echo "KUBECONFIG is set to: $KUBECONFIG"
        export K8S_CLUSTER_URL K8S_CLUSTER_TOKEN
        K8S_CLUSTER_URL=$(oc whoami --show-server)
        echo "K8S_CLUSTER_URL: $K8S_CLUSTER_URL"
        oc create serviceaccount tester-sa-2 -n default
        oc adm policy add-cluster-role-to-user cluster-admin system:serviceaccount:default:tester-sa-2
        K8S_CLUSTER_TOKEN=$(oc create token tester-sa-2 -n default)
        echo "K8S_CLUSTER_TOKEN: $K8S_CLUSTER_TOKEN"

        oc login --token "$K8S_CLUSTER_TOKEN" --server "$K8S_CLUSTER_URL" --insecure-skip-tls-verify=true

        if [[ -s "$KUBEADMIN_PASSWORD_FILE" ]]; then
            OPENSHIFT_PASSWORD="$(cat "$KUBEADMIN_PASSWORD_FILE")"
        elif [[ -s "${SHARED_DIR}/kubeadmin-password" ]]; then
            # Recommendation from hypershift qe team in slack channel..
            OPENSHIFT_PASSWORD="$(cat "${SHARED_DIR}/kubeadmin-password")"
            echo "OPENSHIFT_PASSWORD: $OPENSHIFT_PASSWORD"
        else
            echo "Kubeadmin password file is empty... Aborting job"
            exit 1
        fi

        echo "WHOAMIToken: $(oc whoami -t)"
        ./test/e2e/scripts/prow_run_smoke_test.sh
      from: src
      optional_on_success: true
      resources:
        requests:
          cpu: 100m
      timeout: 15m0s
    workflow: hypershift-hostedcluster-workflow
- always_run: false
  as: pr-image-mirror-maas-api
  skip_if_only_changed: ^docs/|\.md$|^(?:.*/)?(?:\.gitignore|OWNERS|PROJECT|LICENSE)$|^\.github/
  steps:
    dependencies:
      SOURCE_IMAGE_REF: maas-api
    env:
      IMAGE_REPO: maas-api
    workflow: opendatahub-io-ci-image-mirror
- always_run: false
  as: merge-image-mirror-maas-api
  postsubmit: true
  skip_if_only_changed: ^docs/|\.md$|^(?:.*/)?(?:\.gitignore|OWNERS|PROJECT|LICENSE)$|^\.github/
  steps:
    dependencies:
      SOURCE_IMAGE_REF: maas-api
    env:
      IMAGE_REPO: maas-api
      RELEASE_VERSION: latest
    workflow: opendatahub-io-ci-image-mirror
zz_generated_metadata:
  branch: main
  org: opendatahub-io
  repo: maas-billing
