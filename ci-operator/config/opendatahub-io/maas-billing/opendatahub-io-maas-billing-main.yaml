build_root:
  project_image:
    dockerfile_literal: |-
      FROM registry.redhat.io/ubi9/python-311
      USER 0
      RUN yum install -y --nodocs --allowerasing jq
      RUN curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
      RUN mv kustomize /usr/local/bin/
      RUN yum clean all && rm -rf /var/cache/yum
      RUN ln -s /cli/oc /usr/bin/kubectl
images:
- context_dir: maas-api/
  dockerfile_path: Dockerfile
  to: maas-api
promotion:
  to:
  - namespace: opendatahub-io
    tag: latest
releases:
  latest:
    release:
      architecture: multi
      channel: stable
      version: "4.19"
resources:
  '*':
    limits:
      memory: 4Gi
    requests:
      cpu: 100m
      memory: 200Mi
tests:
- always_run: false
  as: e2e-test-maas-api
  skip_if_only_changed: ^docs/|\.md$|^(?:.*/)?(?:\.gitignore|OWNERS|PROJECT|LICENSE)$|^\.github/
  steps:
    cluster_profile: aws-opendatahub
    env:
      BASE_DOMAIN: openshift-ci-aws.rhaiseng.com
      HYPERSHIFT_AWS_REGION: us-west-2
      HYPERSHIFT_NODE_COUNT: "1"
    post:
    - ref: idp-htpasswd
    - as: e2e-maas-api-openshift
      best_effort: true
      cli: latest
      commands: |-
        echo "----- Deploying Maas on OpenShift -----"
        ./deployment/scripts/deploy-openshift.sh
        echo "----- Deploying simulator Model -----"
        kustomize build docs/samples/models/simulator/ | kubectl apply -f -
        echo "----- Deploying facebook-opt-125m-cpu Model -----"
        kustomize build docs/samples/models/facebook-opt-125m-cpu/  | kubectl apply -f -
        sleep 60
        echo "----- Deployment Validation -----"
        ./deployment/scripts/validate-deployment.sh
        echo "----- Running Maas e2e Tests -----"
        echo "-- oc whoami --"
        oc whoami --show-server
        echo "-- Smoke Testing -- "
        export CLUSTER_DOMAIN="$(oc get ingresses.config.openshift.io cluster -o jsonpath='{.spec.domain}')"
        export HOST="maas.${CLUSTER_DOMAIN}"
        export MAAS_API_BASE_URL="http://${HOST}/maas-api"
        bash testing/e2e/smoke.sh
      from: src
      optional_on_success: true
      resources:
        requests:
          cpu: 100m
      timeout: 15m0s
    workflow: hypershift-hostedcluster-workflow
- always_run: false
  as: pr-image-mirror-maas-api
  skip_if_only_changed: ^docs/|\.md$|^(?:.*/)?(?:\.gitignore|OWNERS|PROJECT|LICENSE)$|^\.github/
  steps:
    dependencies:
      SOURCE_IMAGE_REF: maas-api
    env:
      IMAGE_REPO: maas-api
    workflow: opendatahub-io-ci-image-mirror
- always_run: false
  as: merge-image-mirror-maas-api
  postsubmit: true
  skip_if_only_changed: ^docs/|\.md$|^(?:.*/)?(?:\.gitignore|OWNERS|PROJECT|LICENSE)$|^\.github/
  steps:
    dependencies:
      SOURCE_IMAGE_REF: maas-api
    env:
      IMAGE_REPO: maas-api
      RELEASE_VERSION: latest
    workflow: opendatahub-io-ci-image-mirror
zz_generated_metadata:
  branch: main
  org: opendatahub-io
  repo: maas-billing
