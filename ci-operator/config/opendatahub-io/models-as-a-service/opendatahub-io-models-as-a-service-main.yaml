build_root:
  project_image:
    dockerfile_literal: |-
      FROM registry.access.redhat.com/ubi9/go-toolset:1.25
      USER 0
      RUN yum install -y --nodocs --allowerasing jq
      RUN curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
      RUN mv kustomize /usr/local/bin/
      RUN yum clean all && rm -rf /var/cache/yum
      RUN ln -s /cli/oc /usr/bin/kubectl
      RUN ln -s /usr/bin/python3 /usr/bin/python
images:
- context_dir: maas-api/
  dockerfile_path: Dockerfile
  to: maas-api
promotion:
  to:
  - namespace: opendatahub-io
    tag: latest
releases:
  latest:
    release:
      architecture: multi
      channel: stable
      version: "4.19"
resources:
  '*':
    limits:
      memory: 4Gi
    requests:
      cpu: 100m
      memory: 200Mi
tests:
- always_run: false
  as: e2e-test-maas-api
  skip_if_only_changed: ^docs/|\.md$|^(?:.*/)?(?:\.gitignore|OWNERS|PROJECT|LICENSE)$|^\.github/
  steps:
    cluster_profile: aws-opendatahub
    env:
      BASE_DOMAIN: openshift-ci-aws.rhaiseng.com
      HYPERSHIFT_AWS_REGION: us-west-2
      HYPERSHIFT_NODE_COUNT: "3"
    test:
    - as: setup-htpasswd-idp
      cli: latest
      commands: |
        set -euo pipefail
        echo "Setting up htpasswd IDP on hosted cluster..."
        
        # Create htpasswd file with test users
        htpass_file=/tmp/users.htpasswd
        users=""
        for i in $(seq 1 10); do
          username="testuser-${i}"
          password=$(< /dev/urandom tr -dc 'a-z0-9' | fold -w 12 | head -n 1 || true)
          users+="${username}:${password},"
          if [ -f "${htpass_file}" ]; then
            htpasswd -B -b ${htpass_file} "${username}" "${password}"
          else
            htpasswd -c -B -b ${htpass_file} "${username}" "${password}"
          fi
        done
        
        # Get current oauth generation
        gen=$(oc get deployment oauth-openshift -n openshift-authentication -o jsonpath='{.metadata.generation}')
        
        # Create htpasswd secret
        oc create secret generic htpass-secret --from-file=htpasswd=${htpass_file} -n openshift-config
        
        # Patch OAuth to add htpasswd IDP
        oc patch oauth/cluster --type=merge -p '{"spec":{"identityProviders":[{"htpasswd":{"fileData":{"name":"htpass-secret"}},"mappingMethod":"claim","name":"htpasswd-provider","type":"HTPasswd"}]}}'
        
        # Wait for oauth to roll out (up to 10 minutes)
        echo "Waiting for OAuth deployment to roll out..."
        expected_replicas=$(oc get deployment oauth-openshift -n openshift-authentication -o jsonpath='{.spec.replicas}')
        for i in $(seq 1 40); do
          available=$(oc get deployment oauth-openshift -n openshift-authentication -o jsonpath='{.status.availableReplicas}' 2>/dev/null || echo "0")
          new_gen=$(oc get deployment oauth-openshift -n openshift-authentication -o jsonpath='{.metadata.generation}')
          if [[ "${expected_replicas}" == "${available}" && $((new_gen)) -gt $((gen)) ]]; then
            echo "OAuth deployment ready"
            break
          fi
          echo "Waiting... (${i}/40)"
          sleep 15
        done
        
        # Save users to runtime_env for downstream steps
        users=${users::-1}
        echo "export USERS=${users}" >> ${SHARED_DIR}/runtime_env
        echo "htpasswd IDP setup complete"
      from: src
      resources:
        requests:
          cpu: 100m
          memory: 200Mi
      timeout: 15m0s
    - as: e2e-maas-api-openshift
      cli: latest
      commands: ./test/e2e/scripts/prow_run_smoke_test.sh
      dependencies:
      - env: MAAS_API_IMAGE
        name: maas-api
      from: src
      resources:
        requests:
          cpu: 500m
          memory: 512Mi
      timeout: 15m0s
    workflow: hypershift-hostedcluster-workflow
- always_run: false
  as: pr-image-mirror-maas-api
  skip_if_only_changed: ^docs/|\.md$|^(?:.*/)?(?:\.gitignore|OWNERS|PROJECT|LICENSE)$|^\.github/
  steps:
    dependencies:
      SOURCE_IMAGE_REF: maas-api
    env:
      IMAGE_REPO: maas-api
    workflow: opendatahub-io-ci-image-mirror
- always_run: false
  as: merge-image-mirror-maas-api
  postsubmit: true
  skip_if_only_changed: ^docs/|\.md$|^(?:.*/)?(?:\.gitignore|OWNERS|PROJECT|LICENSE)$|^\.github/
  steps:
    dependencies:
      SOURCE_IMAGE_REF: maas-api
    env:
      IMAGE_REPO: maas-api
      RELEASE_VERSION: latest
    workflow: opendatahub-io-ci-image-mirror
zz_generated_metadata:
  branch: main
  org: opendatahub-io
  repo: models-as-a-service
