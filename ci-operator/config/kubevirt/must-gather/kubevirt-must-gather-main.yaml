base_images:
  base:
    name: "4.21"
    namespace: ocp
    tag: base
  cli:
    name: "4.21"
    namespace: ocp
    tag: cli
  cli-operator-sdk:
    name: cli-operator-sdk
    namespace: ocp
    tag: v1.39.2
  hco-bundle-reg:
    name: hyperconverged-cluster-bundle
    namespace: ci
    tag: 1.17.0-unstable
  ocp_builder_rhel-9-golang-1.24-openshift-4.21:
    name: builder
    namespace: ocp
    tag: rhel-9-golang-1.24-openshift-4.21
binary_build_commands: make install
build_root:
  from_repository: true
images:
- dockerfile_path: Dockerfile
  inputs:
    cli:
      as:
      - registry.ci.openshift.org/ocp/4.21:cli
    ocp_builder_rhel-9-golang-1.24-openshift-4.21:
      as:
      - registry.ci.openshift.org/ocp/builder:rhel-9-golang-1.24-openshift-4.21
  to: kubevirt-must-gather
releases:
  initial:
    integration:
      name: "4.21"
      namespace: ocp
  latest:
    integration:
      include_built_images: true
      name: "4.21"
      namespace: ocp
resources:
  '*':
    requests:
      cpu: 500m
      memory: 1Gi
test_binary_build_commands: |-
  (
    cd tests
    go test -c -o must-gather.test .
  )
  mv tests/must-gather.test /go/bin/
tests:
- as: kubevirt-must-gather-e2e-azure
  steps:
    cluster_profile: azure-virtualization
    dependencies:
      OO_BUNDLE: hco-bundle-reg
    env:
      BASE_DOMAIN: cnv-devel.azure.devcluster.openshift.com
      OO_INSTALL_NAMESPACE: kubevirt-hyperconverged
      OO_INSTALL_TIMEOUT_MINUTES: "15"
    test:
    - as: deploy
      cli: latest
      commands: |
        # Create the HyperConverged resource
        curl "https://raw.githubusercontent.com/kubevirt/hyperconverged-cluster-operator/main/deploy/hco.cr.yaml" | oc -n kubevirt-hyperconverged apply -f -
        # Wait for the HyperConverged CR to be available
        oc wait -n kubevirt-hyperconverged HyperConverged "kubevirt-hyperconverged" --for=condition=Available --timeout="1080s"
        ./automation/create_workloads.sh
      from: src
      resources:
        requests:
          cpu: 100m
    - as: test-default
      cli: latest
      commands: |
        oc adm must-gather --image="${KMG_IMAGE}" --dest-dir=${ARTIFACT_DIR}/must-gather-output
        mkdir -p ${ARTIFACT_DIR}/junit
        (cd ${ARTIFACT_DIR}; KUBECONFIG=${KUBECONFIG} /go/bin/must-gather.test --ginkgo.label-filter=level:product --ginkgo.junit-report=${ARTIFACT_DIR}/junit/report.xml --ginkgo.v)
      dependencies:
      - env: KMG_IMAGE
        name: kubevirt-must-gather
      from: test-bin
      resources:
        requests:
          cpu: 100m
    - as: test-targeted
      cli: latest
      commands: |
        oc adm must-gather --image="${KMG_IMAGE}" --dest-dir=${ARTIFACT_DIR}/must-gather-output -- /usr/bin/gather --vms_details --images
        mkdir -p ${ARTIFACT_DIR}/junit
        (cd ${ARTIFACT_DIR}; KUBECONFIG=${KUBECONFIG} /go/bin/must-gather.test --ginkgo.label-filter=level:workloads --ginkgo.junit-report=${ARTIFACT_DIR}/junit/report.xml --ginkgo.v)
      dependencies:
      - env: KMG_IMAGE
        name: kubevirt-must-gather
      from: test-bin
      resources:
        requests:
          cpu: 100m
    - as: test-since
      cli: latest
      commands: |
        oc adm must-gather --since=10m --image="${KMG_IMAGE}" --dest-dir=${ARTIFACT_DIR}/must-gather-output -- /usr/bin/gather --vms_details --images
        mkdir -p ${ARTIFACT_DIR}/junit
        (cd ${ARTIFACT_DIR}; KUBECONFIG=${KUBECONFIG} /go/bin/must-gather.test --ginkgo.label-filter=level:workloads --ginkgo.junit-report=${ARTIFACT_DIR}/junit/report.xml --ginkgo.v)
      dependencies:
      - env: KMG_IMAGE
        name: kubevirt-must-gather
      from: test-bin
      resources:
        requests:
          cpu: 100m
    - as: test-sincetime
      cli: latest
      commands: |
        oc adm must-gather --since-time=$(date -d '-10 minutes' +%Y-%m-%dT%T.%9N%:z ) --image="${KMG_IMAGE}" --dest-dir=${ARTIFACT_DIR}/must-gather-output -- /usr/bin/gather --vms_details --images
        mkdir -p ${ARTIFACT_DIR}/junit
        (cd ${ARTIFACT_DIR}; KUBECONFIG=${KUBECONFIG} /go/bin/must-gather.test --ginkgo.label-filter=level:workloads --ginkgo.junit-report=${ARTIFACT_DIR}/junit/report.xml --ginkgo.v)
      dependencies:
      - env: KMG_IMAGE
        name: kubevirt-must-gather
      from: test-bin
      resources:
        requests:
          cpu: 100m
    - as: test-all-images
      cli: latest
      commands: |
        oc annotate --overwrite -n kubevirt-hyperconverged $(oc get csv -n kubevirt-hyperconverged -l operators.coreos.com/community-kubevirt-hyperconverged.kubevirt-hyperconverged -o name) operators.openshift.io/must-gather-image=${KMG_IMAGE}
        oc adm must-gather --all-images --dest-dir=${ARTIFACT_DIR}/must-gather-output
        mkdir -p ${ARTIFACT_DIR}/junit
        (cd ${ARTIFACT_DIR}; KUBECONFIG=${KUBECONFIG} /go/bin/must-gather.test --ginkgo.label-filter=level:product --ginkgo.junit-report=${ARTIFACT_DIR}/junit/report.xml --ginkgo.v --ginkgo.skip "should validate inspect and node-logs parameters usage on all the relevant logged commands" )
      dependencies:
      - env: KMG_IMAGE
        name: kubevirt-must-gather
      from: test-bin
      resources:
        requests:
          cpu: 100m
    workflow: optional-operators-ci-operator-sdk-azure
- as: kubevirt-must-gather-e2e-gcp
  steps:
    cluster_profile: gcp-virtualization
    dependencies:
      OO_BUNDLE: hco-bundle-reg
    env:
      COMPUTE_NODE_TYPE: n2-standard-4
      OO_INSTALL_NAMESPACE: kubevirt-hyperconverged
      OO_INSTALL_TIMEOUT_MINUTES: "15"
    test:
    - as: deploy
      cli: latest
      commands: |
        # Create the HyperConverged resource
        curl "https://raw.githubusercontent.com/kubevirt/hyperconverged-cluster-operator/main/deploy/hco.cr.yaml" | oc -n kubevirt-hyperconverged apply -f -
        # Wait for the HyperConverged CR to be available
        oc wait -n kubevirt-hyperconverged HyperConverged "kubevirt-hyperconverged" --for=condition=Available --timeout="1080s"
        ./automation/create_workloads.sh
      from: src
      resources:
        requests:
          cpu: 100m
    - as: test-default
      cli: latest
      commands: |
        oc adm must-gather --image="${KMG_IMAGE}" --dest-dir=${ARTIFACT_DIR}/must-gather-output
        mkdir -p ${ARTIFACT_DIR}/junit
        (cd ${ARTIFACT_DIR}; KUBECONFIG=${KUBECONFIG} /go/bin/must-gather.test --ginkgo.label-filter=level:product --ginkgo.junit-report=${ARTIFACT_DIR}/junit/report.xml --ginkgo.v)
      dependencies:
      - env: KMG_IMAGE
        name: kubevirt-must-gather
      from: test-bin
      resources:
        requests:
          cpu: 100m
    - as: test-targeted
      cli: latest
      commands: |
        oc adm must-gather --image="${KMG_IMAGE}" --dest-dir=${ARTIFACT_DIR}/must-gather-output -- /usr/bin/gather --vms_details --images
        mkdir -p ${ARTIFACT_DIR}/junit
        (cd ${ARTIFACT_DIR}; KUBECONFIG=${KUBECONFIG} /go/bin/must-gather.test --ginkgo.label-filter=level:workloads --ginkgo.junit-report=${ARTIFACT_DIR}/junit/report.xml --ginkgo.v)
      dependencies:
      - env: KMG_IMAGE
        name: kubevirt-must-gather
      from: test-bin
      resources:
        requests:
          cpu: 100m
    - as: test-since
      cli: latest
      commands: |
        oc adm must-gather --since=10m --image="${KMG_IMAGE}" --dest-dir=${ARTIFACT_DIR}/must-gather-output -- /usr/bin/gather --vms_details --images
        mkdir -p ${ARTIFACT_DIR}/junit
        (cd ${ARTIFACT_DIR}; KUBECONFIG=${KUBECONFIG} /go/bin/must-gather.test --ginkgo.label-filter=level:workloads --ginkgo.junit-report=${ARTIFACT_DIR}/junit/report.xml --ginkgo.v)
      dependencies:
      - env: KMG_IMAGE
        name: kubevirt-must-gather
      from: test-bin
      resources:
        requests:
          cpu: 100m
    - as: test-sincetime
      cli: latest
      commands: |
        oc adm must-gather --since-time=$(date -d '-10 minutes' +%Y-%m-%dT%T.%9N%:z ) --image="${KMG_IMAGE}" --dest-dir=${ARTIFACT_DIR}/must-gather-output -- /usr/bin/gather --vms_details --images
        mkdir -p ${ARTIFACT_DIR}/junit
        (cd ${ARTIFACT_DIR}; KUBECONFIG=${KUBECONFIG} /go/bin/must-gather.test --ginkgo.label-filter=level:workloads --ginkgo.junit-report=${ARTIFACT_DIR}/junit/report.xml --ginkgo.v)
      dependencies:
      - env: KMG_IMAGE
        name: kubevirt-must-gather
      from: test-bin
      resources:
        requests:
          cpu: 100m
    - as: test-all-images
      cli: latest
      commands: |
        oc annotate --overwrite -n kubevirt-hyperconverged $(oc get csv -n kubevirt-hyperconverged -l operators.coreos.com/community-kubevirt-hyperconverged.kubevirt-hyperconverged -o name) operators.openshift.io/must-gather-image=${KMG_IMAGE}
        oc adm must-gather --all-images --dest-dir=${ARTIFACT_DIR}/must-gather-output
        mkdir -p ${ARTIFACT_DIR}/junit
        (cd ${ARTIFACT_DIR}; KUBECONFIG=${KUBECONFIG} /go/bin/must-gather.test --ginkgo.label-filter=level:product --ginkgo.junit-report=${ARTIFACT_DIR}/junit/report.xml --ginkgo.v --ginkgo.skip "should validate inspect and node-logs parameters usage on all the relevant logged commands" )
      dependencies:
      - env: KMG_IMAGE
        name: kubevirt-must-gather
      from: test-bin
      resources:
        requests:
          cpu: 100m
    workflow: optional-operators-ci-operator-sdk-gcp
zz_generated_metadata:
  branch: main
  org: kubevirt
  repo: must-gather
