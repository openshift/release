base_images:
  aro-hcp-e2e-base-image:
    name: aro-hcp-e2e-base
    namespace: rh_ee_ves
    tag: v1.0
  nested-podman:
    name: nested-podman
    namespace: ci
    tag: latest
binary_build_commands: make -C backend backend
build_root:
  image_stream_tag:
    name: builder
    namespace: ocp
    tag: rhel-9-golang-1.24-openshift-4.20
images:
- dockerfile_literal: |
    FROM nested-podman
    COPY /src /opt/app-root/src/github.com/Azure
    WORKDIR /opt/app-root/src/github.com/Azure/ARO-HCP
    USER root
    # allow anyone to create content in GOPATH so we can go install stuff
    RUN chmod 777 /opt/app-root
    RUN dnf install -y git go make
    RUN dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
    RUN dnf install -y pass || true
    RUN dnf install -y qrencode || true
    RUN dnf install -y net-tools || true
    RUN dnf install -y https://rpmfind.net/linux/centos-stream/9-stream/BaseOS/x86_64/os/Packages/tree-1.8.0-10.el9.x86_64.rpm https://dl.fedoraproject.org/pub/epel/9/Everything/x86_64/Packages/q/qrencode-4.1.1-1.el9.x86_64.rpm https://dl.fedoraproject.org/pub/epel/9/Everything/x86_64/Packages/q/qrencode-libs-4.1.1-1.el9.x86_64.rpm https://dl.fedoraproject.org/pub/epel/9/Everything/x86_64/Packages/p/pass-1.7.4-16.el9.noarch.rpm || true
    RUN dnf clean all
  from: nested-podman
  inputs:
    src:
      paths:
      - destination_dir: src
        source_path: /go/src/github.com/Azure/ARO-HCP
  to: nested-podman-src
- build_args:
  - name: PLATFORM
    value: linux/amd64
  - name: ARO_HCP_REVISION
    value: ci-sha
  - name: ARO_HCP_IMAGE_TAG
    value: ci-test-img
  dockerfile_path: backend/Dockerfile
  from: src
  to: aro-hcp-backend
- build_args:
  - name: PLATFORM
    value: linux/amd64
  - name: ARO_HCP_REVISION
    value: ci-sha
  - name: ARO_HCP_IMAGE_TAG
    value: ci-test-img
  dockerfile_path: frontend/Dockerfile
  from: src
  to: aro-hcp-frontend
- dockerfile_literal: |
    FROM aro-hcp-e2e-base-image
    USER root
    COPY /src /opt/app-root/src/github.com/Azure
    WORKDIR /opt/app-root/src/github.com/Azure/ARO-HCP
    ENV GOBIN="$(go env GOPATH)/bin"
    ENV PATH="$GOBIN:/usr/local/bin:/usr/bin:$PATH"
    RUN export GOFLAGS='-mod=readonly' && \
        make install-tools && \
        make -C tooling/templatize templatize && \
        make -C test/ aro-hcp-tests prow-job-executor
  from: aro-hcp-e2e-base-image
  inputs:
    src:
      paths:
      - destination_dir: src
        source_path: /go/src/github.com/Azure/ARO-HCP
  to: aro-hcp-e2e-tools
- dockerfile_literal: |
    FROM aro-hcp-e2e-base-image
    USER root
    COPY /src /opt/app-root/src/github.com/Azure
    WORKDIR /opt/app-root/src/github.com/Azure/ARO-HCP
    ENV GOBIN="/usr/local/bin"
    ENV PATH="/usr/local/bin:/usr/bin:$PATH"
    RUN mkdir -p "$(go env GOROOT)" && chmod 777 "$(go env GOROOT)"
    RUN mkdir -p "$(go env GOPATH)" && chmod 777 "$(go env GOPATH)"
    RUN mkdir -p "$(go env GOCACHE)" && chmod 777 "$(go env GOCACHE)"
    RUN mkdir -p "$(go env GOBIN)" && chmod 777 "$(go env GOBIN)"
    RUN chmod 777 /opt/app-root/src/github.com/Azure/ARO-HCP
    RUN curl -sfLo - https://github.com/prometheus/prometheus/releases/download/v3.2.1/prometheus-3.2.1.linux-amd64.tar.gz | tar xzf - && \
        mv prometheus-3.2.1.linux-amd64/promtool /usr/local/bin/promtool && \
        chmod +x /usr/local/bin/promtool && \
        rm -rf prometheus-3.2.1.linux-amd64
    RUN rpm --import https://packages.microsoft.com/keys/microsoft.asc
    RUN dnf install -y https://packages.microsoft.com/config/rhel/9.0/packages-microsoft-prod.rpm
    RUN dnf install -y azure-cli libicu
    RUN az bicep install
    # Move bicep to a system-wide location
    RUN mv /root/.azure/bin/bicep /usr/local/bin/bicep
    RUN dnf install -y wget
    RUN curl -sfLo /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64 && \
        chmod +x /usr/local/bin/yq
    # Install Python for grafana tests
    RUN dnf install -y python3 python3-pip
    RUN pip3 install black
  from: aro-hcp-e2e-base-image
  inputs:
    src:
      paths:
      - destination_dir: src
        source_path: /go/src/github.com/Azure/ARO-HCP
  to: aro-hcp-tools
releases:
  latest:
    release:
      channel: stable
      version: "4.20"
resources:
  '*':
    limits:
      memory: 4Gi
    requests:
      cpu: "3"
      memory: 4Gi
  aro-hcp-e2e-tools:
    limits:
      memory: 10Gi
    requests:
      cpu: "8"
      memory: 8Gi
test_binary_build_commands: make test-compile
tests:
- as: test-unit
  steps:
    test:
    - ref: aro-hcp-test-unit
- as: verify
  steps:
    test:
    - ref: aro-hcp-verify
- as: lint
  steps:
    test:
    - ref: aro-hcp-lint
- as: config-change-detection
  steps:
    test:
    - ref: aro-hcp-config-change-detection
- as: mega-linter
  capabilities:
  - nested-podman
  nested_podman: true
  steps:
    test:
    - ref: aro-hcp-mega-lint
- as: observability-prometheus
  run_if_changed: ^observability/(alerts|prometheus)/
  steps:
    test:
    - ref: aro-hcp-observability-prometheus
- as: observability-grafana
  run_if_changed: ^observability/grafana/
  steps:
    test:
    - ref: aro-hcp-observability-grafana
- always_run: false
  as: frontend-simulation
  capabilities:
  - nested-podman
  nested_podman: true
  optional: true
  steps:
    test:
    - ref: aro-hcp-frontend-run-integration-tests
- always_run: true
  as: integration
  capabilities:
  - nested-podman
  nested_podman: true
  steps:
    test:
    - ref: aro-hcp-frontend-run-integration-tests
- always_run: false
  as: integration-e2e-parallel
  optional: true
  steps:
    cluster_profile: aro-hcp-int
    env:
      ARO_HCP_SUITE_NAME: integration/parallel
      LOCATION: uksouth
    workflow: aro-hcp-e2e
- always_run: false
  as: stage-e2e-parallel
  optional: true
  steps:
    cluster_profile: aro-hcp-stg
    env:
      ARO_HCP_SUITE_NAME: stage/parallel
      LOCATION: uksouth
    workflow: aro-hcp-e2e
- always_run: false
  as: prod-e2e-parallel
  optional: true
  steps:
    cluster_profile: aro-hcp-prod
    env:
      ARO_HCP_SUITE_NAME: prod/parallel
      LOCATION: uksouth
    workflow: aro-hcp-e2e
- always_run: true
  as: e2e-parallel
  skip_if_only_changed: ^(?:action\.yml|AGENTS\.md|CLAUDE\.md|CODEOWNERS|CONTRIBUTING\.md|\.bingo/|\.cursor/|\.devcontainer/|docs/|\.editorconfig|GEMINI\.md|generate-repo\.sh|generate-tag\.sh|get-digest\.sh|get-tag-sha\.sh|\.gitattributes|\.gitguardian\.yaml|\.github/|\.gitleaks\.toml|\.golangci\.yml|LICENSE|\.mega-linter\.yml|README\.md|SECURITY\.md|svc-deploy\.sh|\.vscode/|\.yamlfmt\.yaml|\.yamllint\.yml)$|\.md$
  steps:
    cluster_profile: aro-hcp-dev
    env:
      LOCATION: westus3
    workflow: aro-hcp-local-e2e
zz_generated_metadata:
  branch: main
  org: Azure
  repo: ARO-HCP
