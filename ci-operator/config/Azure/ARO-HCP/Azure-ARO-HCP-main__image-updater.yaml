base_images:
  aro-hcp-e2e-base-image:
    name: aro-hcp-e2e-base
    namespace: rh_ee_ves
    tag: v1.0
  prcreator:
    name: prcreator
    namespace: ci
    tag: latest
build_root:
  image_stream_tag:
    name: builder
    namespace: ocp
    tag: rhel-9-golang-1.24-openshift-4.20
images:
- dockerfile_literal: |
    FROM aro-hcp-e2e-base-image
    RUN dnf install -y skopeo jq
    RUN curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o /usr/local/bin/yq &&\
        chmod +x /usr/local/bin/yq
    ADD prcreator /usr/bin/prcreator
    COPY /src /opt/app-root/src/github.com/Azure
    WORKDIR /opt/app-root/src/github.com/Azure/ARO-HCP
  from: aro-hcp-e2e-base-image
  inputs:
    prcreator:
      paths:
      - destination_dir: .
        source_path: /usr/bin/prcreator
    src:
      paths:
      - destination_dir: src
        source_path: /go/src/github.com/Azure/ARO-HCP
  to: image-updater-base
resources:
  '*':
    requests:
      cpu: 500m
      memory: 1Gi
tests:
- as: image-updater-tooling
  cron: 0 2 * * 1-5
  steps:
    test:
    - as: update-images
      commands: |
        #!/bin/bash
        set -o errexit
        set -o nounset
        set -o pipefail

        echo "===== Precheck: Ensure required tools are present ====="
        for cmd in skopeo git az bicep yq jq; do
          if ! command -v "$cmd" &> /dev/null; then
            echo "ERROR: Required tool '$cmd' is not installed or not in PATH."
            exit 1
          fi
        done
        echo "All required tools are present: skopeo, git, az, bicep."

        echo "===== Configure Azure Authentication ====="
        export AZURE_CLIENT_ID
        AZURE_CLIENT_ID=$(cat /var/run/hcp-integration-credentials/client-id)
        export AZURE_CLIENT_SECRET
        AZURE_CLIENT_SECRET=$(cat /var/run/hcp-integration-credentials/client-secret)
        export AZURE_TENANT_ID
        AZURE_TENANT_ID=$(cat /var/run/hcp-integration-credentials/tenant)

        echo "===== Sync Go workspace vendor directory ====="
        go work vendor

        # Configure git
        git config user.name "openshift-ci-robot"
        git config user.email "openshift-ci-robot@users.noreply.github.com"

        echo "===== Building image-updater ====="
        cd tooling/image-updater
        make build

        echo "===== Running image-updater for all components ====="
        ./image-updater update --config config.yaml | tee /tmp/image-updater-output.txt

        # Check if there are any changes
        if [[ $(git status --porcelain) == "" ]]; then
          echo "No image updates needed for any components"
          exit 0
        fi

        cd ../..

        git add .
        git commit -m "chore: execute image-updater for all components"

        echo "===== Rendering ACM helm-charts ====="
        make -C acm helm-charts
        make yamlfmt && UPDATE=true go test ./tooling/helmtest/...
        
        if [[ $(git status --porcelain) != "" ]]; then
          git add .
          git commit -m "chore: render ACM helm-charts"
        fi

        echo "===== Materializing configuration ====="
        make -C config materialize
        git add .
        git commit -m "chore: render digests using materialize"

        echo "===== Tidying and formatting code ====="
        make all-tidy
        make yamlfmt

        echo "===== Changes detected ====="
        git status --short

        echo "===== Creating PR ====="
        # Use the image-updater output directly for PR message
        UPDATE_SUMMARY=$(cat /tmp/image-updater-output.txt)

        /usr/bin/prcreator \
          -github-token-path=/etc/github/oauth \
          -organization=Azure \
          -repo=ARO-HCP \
          -branch=main \
          -git-message="chore: tidy and format code" \
          -pr-title="Automated - Update component image digests" \
          -pr-message="This automated PR updates ARO-HCP container image digests to the latest versions from registries.

        ${UPDATE_SUMMARY}

        ---
        **Schedule:** Monday through Friday at 2 AM UTC  
        **Generated by:** [periodic-ci-Azure-ARO-HCP-main-image-updater-tooling](https://prow.ci.openshift.org/?job=periodic-ci-Azure-ARO-HCP-main-image-updater-tooling)
        "

        echo "===== Sending Slack notification ====="
        WEBHOOK_URL=$(cat /var/run/slack-webhook/webhook)
        curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"ðŸ”„ Image digest update PR created. Please review: https://github.com/Azure/ARO-HCP/pulls?q=is%3Apr+is%3Aopen+author%3Aopenshift-ci-robot\"}" "${WEBHOOK_URL}"
      credentials:
      - collection: ""
        mount_path: /etc/github
        name: github-credentials-openshift-ci-robot-private-git-cloner
        namespace: ci
      - collection: ""
        mount_path: /var/run/hcp-integration-credentials
        name: hcp-integration-credentials
        namespace: test-credentials
      - collection: ""
        mount_path: /var/run/slack-webhook
        name: aro-hcp-image-bump-slack-webhook
        namespace: test-credentials
      from: image-updater-base
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
zz_generated_metadata:
  branch: main
  org: Azure
  repo: ARO-HCP
  variant: image-updater
