base_images:
  prcreator:
    name: prcreator
    namespace: ci
    tag: latest
build_root:
  image_stream_tag:
    name: builder
    namespace: ocp
    tag: rhel-9-golang-1.24-openshift-4.20
images:
- dockerfile_literal: |
    FROM src
    RUN cat /etc/dnf/dnf.conf || true
    RUN rpm --import https://packages.microsoft.com/keys/microsoft.asc
    RUN dnf install -y https://packages.microsoft.com/config/rhel/9.0/packages-microsoft-prod.rpm
    RUN ln -s /etc/yum.repos.d/microsoft-prod.repo /etc/yum.repos.art/ci/
    RUN dnf install -y azure-cli libicu git
    ADD prcreator /usr/bin/prcreator
  from: src
  inputs:
    prcreator:
      paths:
      - destination_dir: .
        source_path: /usr/bin/prcreator
  to: image-updater-base
resources:
  '*':
    requests:
      cpu: 500m
      memory: 1Gi
tests:
- as: image-updater-all-components
  cron: 0 2 * * 1-5
  steps:
    test:
    - as: update-images
      commands: |
        #!/bin/bash
        set -o errexit
        set -o nounset
        set -o pipefail

        echo "===== Configuring Azure Authentication ====="
        export AZURE_CLIENT_ID; AZURE_CLIENT_ID=$(cat /var/run/hcp-integration-credentials/client-id)
        export AZURE_CLIENT_SECRET; AZURE_CLIENT_SECRET=$(cat /var/run/hcp-integration-credentials/client-secret)
        export AZURE_TENANT_ID; AZURE_TENANT_ID=$(cat /var/run/hcp-integration-credentials/tenant)

        echo "===== Syncing Go workspace vendor directory ====="
        go work vendor

        echo "===== Building image-updater ====="
        cd tooling/image-updater
        make build

        echo "===== Running image-updater for all components ====="
        ./image-updater update --config config.yaml

        cd ../..

        # Check if there are any changes after image-updater
        if [[ $(git status --porcelain) != "" ]]; then
          echo "===== Committing image digest updates ====="
          git add .
          git commit -m "Update image digests

        This commit updates the following component image digests:
        - maestro
        - hypershift
        - pko-package
        - pko-manager
        - pko-remote-phase-manager
        - arohcpfrontend
        - arohcpbackend"
        fi

        echo "===== Materializing configuration ====="
        make -C config materialize

        # Check if materialization created changes
        if [[ $(git status --porcelain) != "" ]]; then
          echo "===== Committing materialized configuration ====="
          git add .
          git commit -m "Materialize configuration with updated digests"
        fi

        # Check if we have any commits to push
        if git log origin/main..HEAD --oneline | grep -q .; then
          echo "===== Changes detected ====="
          git log --oneline -3
        else
          echo "No image updates needed for any components"
          exit 0
        fi

        echo "===== Creating PR ====="
        /usr/bin/prcreator \
          -github-token-path=/etc/github/oauth \
          -organization=Azure \
          -repo=ARO-HCP \
          -branch=main \
          -pr-title="Automated - Update all image digests" \
          -pr-message="This automated PR updates all ARO-HCP container image digests to the latest versions from registries.

        **Components Updated:**
        - \`maestro\` - Maestro operator (quay.io/redhat-user-workloads/maestro-rhtap-tenant/maestro/maestro)
        - \`hypershift\` - HyperShift operator (quay.io/acm-d/rhtap-hypershift-operator)
        - \`pko-package\` - Package Operator package (quay.io/package-operator/package-operator-package)
        - \`pko-manager\` - Package Operator manager (quay.io/package-operator/package-operator-manager)
        - \`pko-remote-phase-manager\` - Remote Phase Manager (quay.io/package-operator/remote-phase-manager)
        - \`arohcpfrontend\` - Frontend service (arohcpsvcdev.azurecr.io/arohcpfrontend)
        - \`arohcpbackend\` - Backend service (arohcpsvcdev.azurecr.io/arohcpbackend)

        **Schedule:** Monday through Friday at 2 AM UTC

        **Generated by:** [periodic-ci-Azure-ARO-HCP-main-image-updater-all-components](https://prow.ci.openshift.org/?job=periodic-ci-Azure-ARO-HCP-main-image-updater-all-components)

        ---

        /cc @hbhushan @geoberle @mmazur @roivaz @venkateshsredhat @bennerv @mbarnes @SudoBrendan

        Please review the image digest changes and merge if CI passes."
      credentials:
      - collection: ""
        mount_path: /etc/github
        name: github-credentials-openshift-ci-robot-private-git-cloner
        namespace: ci
      - collection: ""
        mount_path: /var/run/hcp-integration-credentials
        name: hcp-integration-credentials
        namespace: test-credentials
      from: image-updater-base
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
zz_generated_metadata:
  branch: main
  org: Azure
  repo: ARO-HCP
  variant: image-updater
