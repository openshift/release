base_images:
  prcreator:
    name: prcreator
    namespace: ci
    tag: latest
build_root:
  image_stream_tag:
    name: builder
    namespace: ocp
    tag: rhel-9-golang-1.24-openshift-4.20
images:
- dockerfile_literal: |
    FROM src
    RUN cat /etc/dnf/dnf.conf || true
    RUN rpm --import https://packages.microsoft.com/keys/microsoft.asc
    RUN dnf install -y https://packages.microsoft.com/config/rhel/9.0/packages-microsoft-prod.rpm
    RUN ln -s /etc/yum.repos.d/microsoft-prod.repo /etc/yum.repos.art/ci/
    RUN dnf install -y azure-cli libicu git
    ADD prcreator /usr/bin/prcreator
  from: src
  inputs:
    prcreator:
      paths:
      - destination_dir: .
        source_path: /usr/bin/prcreator
  to: image-updater-base
resources:
  '*':
    requests:
      cpu: 500m
      memory: 1Gi
tests:
- as: image-updater-all-components
  cron: 0 2 * * 1-5
  steps:
    test:
    - as: update-images
      commands: |
        #!/bin/bash
        set -o errexit
        set -o nounset
        set -o pipefail

        echo "===== Configure Azure Authentication ====="
        export AZURE_CLIENT_ID; AZURE_CLIENT_ID=$(cat /var/run/hcp-integration-credentials/client-id)
        export AZURE_CLIENT_SECRET; AZURE_CLIENT_SECRET=$(cat /var/run/hcp-integration-credentials/client-secret)
        export AZURE_TENANT_ID; AZURE_TENANT_ID=$(cat /var/run/hcp-integration-credentials/tenant)

        echo "===== Sync Go workspace vendor directory ====="
        go work vendor

        # Configure git
        git config user.name "openshift-ci-robot"
        git config user.email "openshift-ci-robot@users.noreply.github.com"

        echo "===== Building image-updater ====="
        cd tooling/image-updater
        make build

        echo "===== Running image-updater for all components ====="
        ./image-updater update --config config.yaml | tee /tmp/image-updater-output.txt

        # Check if there are any changes
        if [[ $(git status --porcelain) == "" ]]; then
          echo "No image updates needed for any components"
          exit 0
        fi

        cd ../..

        git add .
        git commit -m "Ran image-updater for all components"

        echo "===== Materializing configuration ====="
        make -C config materialize

        echo "===== Changes detected ====="
        git status --short

        echo "===== Creating PR ====="
        # Use the image-updater output directly for PR message
        UPDATE_SUMMARY=$(cat /tmp/image-updater-output.txt)
        
        /usr/bin/prcreator \
          -github-token-path=/etc/github/oauth \
          -organization=Azure \
          -repo=ARO-HCP \
          -branch=main \
          -git-message="Ran materialize" \
          -pr-title="Automated - Update component image digests" \
          -pr-message="This automated PR updates ARO-HCP container image digests to the latest versions from registries.

        ${UPDATE_SUMMARY}

        ---
        **Schedule:** Monday through Friday at 2 AM UTC  
        **Generated by:** [periodic-ci-Azure-ARO-HCP-main-image-updater-all-components](https://prow.ci.openshift.org/?job=periodic-ci-Azure-ARO-HCP-main-image-updater-all-components)

        /cc @hbhushan @geoberle @mmazur @roivaz @venkateshsredhat @bennerv @mbarnes @SudoBrendan"
      credentials:
      - collection: ""
        mount_path: /etc/github
        name: github-credentials-openshift-ci-robot-private-git-cloner
        namespace: ci
      - collection: ""
        mount_path: /var/run/hcp-integration-credentials
        name: hcp-integration-credentials
        namespace: test-credentials
      from: image-updater-base
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
zz_generated_metadata:
  branch: main
  org: Azure
  repo: ARO-HCP
  variant: image-updater
