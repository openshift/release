base_images:
  prcreator:
    name: prcreator
    namespace: ci
    tag: latest
build_root:
  image_stream_tag:
    name: builder
    namespace: ocp
    tag: rhel-9-golang-1.24-openshift-4.20
images:
- dockerfile_literal: |
    FROM src
    RUN cat /etc/dnf/dnf.conf || true
    RUN rpm --import https://packages.microsoft.com/keys/microsoft.asc
    RUN dnf install -y https://packages.microsoft.com/config/rhel/9.0/packages-microsoft-prod.rpm
    RUN ln -s /etc/yum.repos.d/microsoft-prod.repo /etc/yum.repos.art/ci/
    RUN dnf install -y azure-cli libicu git
    ADD prcreator /usr/bin/prcreator
  from: src
  inputs:
    prcreator:
      paths:
      - destination_dir: .
        source_path: /usr/bin/prcreator
  to: image-updater-base
resources:
  '*':
    requests:
      cpu: 500m
      memory: 1Gi
tests:
- as: image-updater-tooling
  cron: 0 2 * * 1-5
  steps:
    test:
    - as: update-images
      commands: "#!/bin/bash\nset -o errexit\nset -o nounset\nset -o pipefail\n\necho
        \"===== Configure Azure Authentication =====\"\nexport AZURE_CLIENT_ID; AZURE_CLIENT_ID=$(cat
        /var/run/hcp-integration-credentials/client-id)\nexport AZURE_CLIENT_SECRET;
        AZURE_CLIENT_SECRET=$(cat /var/run/hcp-integration-credentials/client-secret)\nexport
        AZURE_TENANT_ID; AZURE_TENANT_ID=$(cat /var/run/hcp-integration-credentials/tenant)\n\necho
        \"===== Sync Go workspace vendor directory =====\"\ngo work vendor\n\n# Configure
        git\ngit config user.name \"openshift-ci-robot\"\ngit config user.email \"openshift-ci-robot@users.noreply.github.com\"\n\necho
        \"===== Building image-updater =====\"\ncd tooling/image-updater\nmake build\n\necho
        \"===== Running image-updater for all components =====\"\n./image-updater
        update --config config.yaml | tee /tmp/image-updater-output.txt\n\n# Check
        if there are any changes\nif [[ $(git status --porcelain) == \"\" ]]; then\n
        \ echo \"No image updates needed for any components\"\n  exit 0\nfi\n\ncd
        ../..\n\ngit add .\ngit commit -m \"Ran image-updater for all components\"\n\necho
        \"===== Materializing configuration =====\"\nmake -C config materialize\n\necho
        \"===== Changes detected =====\"\ngit status --short\n\necho \"===== Creating
        PR =====\"\n# Use the image-updater output directly for PR message\nUPDATE_SUMMARY=$(cat
        /tmp/image-updater-output.txt)\n\n/usr/bin/prcreator \\\n  -github-token-path=/etc/github/oauth
        \\\n  -organization=Azure \\\n  -repo=ARO-HCP \\\n  -branch=main \\\n  -git-message=\"Ran
        materialize\" \\\n  -pr-title=\"Automated - Update component image digests\"
        \\\n  -pr-message=\"This automated PR updates ARO-HCP container image digests
        to the latest versions from registries.\n\n${UPDATE_SUMMARY}\n\n---\n**Schedule:**
        Monday through Friday at 2 AM UTC  \n**Generated by:** [periodic-ci-Azure-ARO-HCP-main-image-updater-tooling](https://prow.ci.openshift.org/?job=periodic-ci-Azure-ARO-HCP-main-image-updater-tooling)\"\n\necho
        \"===== Sending Slack notification =====\"\nWEBHOOK_URL=$(cat /var/run/slack-webhook/webhook)\ncurl
        -X POST -H 'Content-type: application/json' --data \"{\\\"text\\\":\\\"\U0001F504
        Image digest update PR created. Please review: https://github.com/Azure/ARO-HCP/pulls?q=is%3Apr+is%3Aopen+author%3Aopenshift-ci-robot\\\"}\"
        \"${WEBHOOK_URL}\"\n"
      credentials:
      - collection: ""
        mount_path: /etc/github
        name: github-credentials-openshift-ci-robot-private-git-cloner
        namespace: ci
      - collection: ""
        mount_path: /var/run/hcp-integration-credentials
        name: hcp-integration-credentials
        namespace: test-credentials
      - collection: ""
        mount_path: /var/run/slack-webhook
        name: aro-hcp-image-bump-slack-webhook
        namespace: test-credentials
      from: image-updater-base
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
zz_generated_metadata:
  branch: main
  org: Azure
  repo: ARO-HCP
  variant: image-updater
