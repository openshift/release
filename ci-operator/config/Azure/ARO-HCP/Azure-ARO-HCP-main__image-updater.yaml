binary_build_commands: GO_COMPLIANCE_INFO=0 make build
build_root:
  image_stream_tag:
    name: builder
    namespace: ocp
    tag: rhel-9-golang-1.24-openshift-4.20
images:
- dockerfile_literal: |
    FROM src
    RUN cat /etc/dnf/dnf.conf || true
    RUN rpm --import https://packages.microsoft.com/keys/microsoft.asc
    RUN dnf install -y https://packages.microsoft.com/config/rhel/9.0/packages-microsoft-prod.rpm
    RUN ln -s /etc/yum.repos.d/microsoft-prod.repo /etc/yum.repos.art/ci/
    RUN dnf install -y azure-cli libicu git
  from: src
  to: image-updater-base
resources:
  '*':
    requests:
      cpu: 500m
      memory: 1Gi
tests:
- as: image-updater-frontend-backend
  cron: 0 2 * * 2,3,5
  steps:
    test:
    - as: update-images
      commands: |
        #!/bin/bash
        set -o errexit
        set -o nounset
        set -o pipefail

        # Generate timestamp for branch naming
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        BRANCH_NAME="image-updater-frontend-backend-${TIMESTAMP}"

        echo "===== Building image-updater ====="
        cd tooling/image-updater
        make build

        echo "===== Running image-updater for frontend/backend ====="
        ./image-updater update \
          --config config.yaml \
          --components arohcpfrontend,arohcpbackend

        cd ../..

        echo "===== Materializing configuration ====="
        make -C config materialize

        # Check if there are any changes after materialization
        if [[ $(git status --porcelain) == "" ]]; then
          echo "No image updates needed for frontend/backend"
          exit 0
        fi

        echo "===== Changes detected ====="
        git status --short

        echo "===== Creating PR ====="
        /usr/bin/prcreator \
          -github-token-path=/etc/github/oauth \
          -organization=Azure \
          -repo=ARO-HCP \
          -branch=main \
          -git-message="[auto] Update frontend and backend image digests

        This automated PR updates the following component image digests:
        - arohcpfrontend
        - arohcpbackend

        Generated by: periodic-ci-Azure-ARO-HCP-main-image-updater-frontend-backend
        Timestamp: ${TIMESTAMP}" \
          -pr-title="[auto] Update frontend and backend image digests" \
          -pr-message="This automated PR updates frontend and backend container image digests to the latest versions from registries.

        **Components Updated:**
        - \`arohcpfrontend\` - Frontend service image
        - \`arohcpbackend\` - Backend service image

        **Schedule:** Tuesday, Wednesday, Friday at 2 AM UTC

        **Generated by:** [periodic-ci-Azure-ARO-HCP-main-image-updater-frontend-backend](https://prow.ci.openshift.org/?job=periodic-ci-Azure-ARO-HCP-main-image-updater-frontend-backend)

        **Details:**
        - Timestamp: \`${TIMESTAMP}\`
        - Branch: \`${BRANCH_NAME}\`

        ---

        /cc @hbhushan @geoberle @mmazur @roivaz @venkateshsredhat @bennerv @mbarnes @SudoBrendan

        Please review the image digest changes and merge if CI passes." \
          -pr-assignee=hbhushan,geoberle,mmazur
      credentials:
      - collection: ""
        mount_path: /etc/github
        name: github-credentials-openshift-bot
        namespace: test-credentials
      from: image-updater-base
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
- as: image-updater-all-components
  cron: 0 2 * * 1,4
  steps:
    test:
    - as: update-images
      commands: |
        #!/bin/bash
        set -o errexit
        set -o nounset
        set -o pipefail

        # Generate timestamp for branch naming
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        BRANCH_NAME="image-updater-all-components-${TIMESTAMP}"

        echo "===== Building image-updater ====="
        cd tooling/image-updater
        make build

        echo "===== Running image-updater for all components ====="
        ./image-updater update --config config.yaml

        cd ../..

        echo "===== Materializing configuration ====="
        make -C config materialize

        # Check if there are any changes after materialization
        if [[ $(git status --porcelain) == "" ]]; then
          echo "No image updates needed for any components"
          exit 0
        fi

        echo "===== Changes detected ====="
        git status --short

        echo "===== Creating PR ====="
        /usr/bin/prcreator \
          -github-token-path=/etc/github/oauth \
          -organization=Azure \
          -repo=ARO-HCP \
          -branch=main \
          -git-message="[auto] Update all component image digests

        This automated PR updates image digests for all ARO-HCP components:
        - maestro
        - hypershift
        - pko-package
        - pko-manager
        - pko-remote-phase-manager
        - arohcpfrontend
        - arohcpbackend

        Generated by: periodic-ci-Azure-ARO-HCP-main-image-updater-all-components
        Timestamp: ${TIMESTAMP}" \
          -pr-title="[auto] Update all component image digests" \
          -pr-message="This automated PR updates all ARO-HCP container image digests to the latest versions from registries.

        **Components Updated:**
        - \`maestro\` - Maestro operator (quay.io/redhat-user-workloads/maestro-rhtap-tenant/maestro/maestro)
        - \`hypershift\` - HyperShift operator (quay.io/acm-d/rhtap-hypershift-operator)
        - \`pko-package\` - Package Operator package (quay.io/package-operator/package-operator-package)
        - \`pko-manager\` - Package Operator manager (quay.io/package-operator/package-operator-manager)
        - \`pko-remote-phase-manager\` - Remote Phase Manager (quay.io/package-operator/remote-phase-manager)
        - \`arohcpfrontend\` - Frontend service (arohcpsvcdev.azurecr.io/arohcpfrontend)
        - \`arohcpbackend\` - Backend service (arohcpsvcdev.azurecr.io/arohcpbackend)

        **Schedule:** Monday, Thursday at 2 AM UTC

        **Generated by:** [periodic-ci-Azure-ARO-HCP-main-image-updater-all-components](https://prow.ci.openshift.org/?job=periodic-ci-Azure-ARO-HCP-main-image-updater-all-components)

        **Details:**
        - Timestamp: \`${TIMESTAMP}\`
        - Branch: \`${BRANCH_NAME}\`

        ---

        /cc @hbhushan @geoberle @mmazur @roivaz @venkateshsredhat @bennerv @mbarnes @SudoBrendan

        Please review the image digest changes and merge if CI passes." \
          -pr-assignee=hbhushan,geoberle,mmazur
      credentials:
      - collection: ""
        mount_path: /etc/github
        name: github-credentials-openshift-bot
        namespace: test-credentials
      from: image-updater-base
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
zz_generated_metadata:
  branch: main
  org: Azure
  repo: ARO-HCP
  variant: image-updater
