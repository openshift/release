base_images:
  golangci-lint:
    name: golangci-lint
    namespace: ci
    tag: v1.63.4
  govulncheck:
    name: govulncheck
    namespace: ci
    tag: latest
build_root:
  project_image:
    dockerfile_literal: |
      FROM registry.ci.openshift.org/openshift/release:rhel-9-release-golang-1.23-openshift-4.19

      # Pre-install Python 3.12
      RUN dnf install -y python3.12 python3.12-pip python3.12-devel && \
          dnf clean all

      # Set default python interpreter for the container
      ENV PYTHON=python3.12
images:
- dockerfile_literal: |
    FROM src
    # Install dependencies from pyproject.toml
    RUN cd python && python3.12 -m pip install .[dev,gcs]
  from: src
  to: tests-image
resources:
  '*':
    requests:
      cpu: 100m
      memory: 1Gi
tests:
- as: go-lint
  commands: cd go && HOME=/tmp golangci-lint run --timeout=20m
  container:
    from: golangci-lint
- as: python-lint
  commands: cd python && python3.12 -m ruff check .
  container:
    from: tests-image
- as: python-typing
  commands: |
    export HOME=/tmp
    make python-typing
  container:
    from: tests-image
- as: unit
  commands: |
    export HOME=/tmp
    # Run all tests via root Makefile
    make test
  container:
    from: tests-image
- as: validate-parity
  commands: |
    export HOME=/tmp
    make validate-parity
  container:
    from: tests-image
- as: go-vulncheck
  commands: cd go && GOCACHE=$(mktemp -d) GOMODCACHE=$(mktemp -d) govulncheck ./...
  container:
    from: govulncheck
  optional: true
- as: go-verify
  commands: |
    cd go
    go mod verify
    go mod tidy
    git diff --exit-code go.mod go.sum
  container:
    from: src
zz_generated_metadata:
  branch: main
  org: openshift-eng
  repo: cyborg-data
