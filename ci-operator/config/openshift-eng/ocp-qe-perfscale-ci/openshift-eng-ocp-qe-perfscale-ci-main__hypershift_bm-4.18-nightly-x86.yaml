base_images:
  assisted-service-scripts:
    name: ocm-2.13
    namespace: edge-infrastructure
    tag: assisted-service-scripts
  dev-scripts:
    name: test
    namespace: ocp-kni
    tag: dev-scripts
  hypershift-operator:
    name: hypershift-operator
    namespace: hypershift
    tag: latest
  hypershift-tests:
    name: hypershift-tests
    namespace: hypershift
    tag: latest
  test-bin:
    name: "4.18"
    namespace: ocp
    tag: hypershift-tests
  upi-installer:
    name: "4.18"
    namespace: ocp
    tag: upi-installer
releases:
  latest:
    candidate:
      product: ocp
      stream: nightly
      version: "4.18"
resources:
  '*':
    requests:
      cpu: 100m
      memory: 200Mi
tests:
- as: control-plane-6nodes
  cron: 0 2 9,16 * *
  steps:
    allow_skip_on_success: true
    cluster_profile: equinix-ocp-hcp
    env:
      DEVSCRIPTS_CONFIG: |
        IP_STACK=v4
        NUM_WORKERS=3
        NUM_MASTERS=3
        MASTER_VCPU=16
        MASTER_MEMORY=40960
        NETWORK_TYPE=OVNKubernetes
        VM_EXTRADISKS=true
        VM_EXTRADISKS_LIST=vda
        VM_EXTRADISKS_SIZE=100G
        NUM_EXTRA_WORKERS=6
        EXTRA_WORKER_VCPU=4
        EXTRA_WORKER_MEMORY=16384
      ES_SECRETS_PATH: /prod-secret
      LVM_OPERATOR_SUB_CHANNEL: stable-4.18
      MCE_VERSION: "2.8"
      PPROF: "false"
    test:
    - chain: openshift-qe-control-plane
    workflow: openshift-qe-installer-hypershift-mce-agent-metal3
- as: ovs-timeout-stress-test
  cron: 0 6 * * 1,3,5
  steps:
    allow_skip_on_success: true
    cluster_profile: equinix-ocp-hcp
    env:
      DEVSCRIPTS_CONFIG: |
        IP_STACK=v4
        NUM_WORKERS=3
        NUM_MASTERS=3
        MASTER_VCPU=16
        MASTER_MEMORY=40960
        NETWORK_TYPE=OVNKubernetes
        VM_EXTRADISKS=true
        VM_EXTRADISKS_LIST=vda
        VM_EXTRADISKS_SIZE=100G
        NUM_EXTRA_WORKERS=6
        EXTRA_WORKER_VCPU=4
        EXTRA_WORKER_MEMORY=16384
      LVM_OPERATOR_SUB_CHANNEL: stable-4.18
      MCE_VERSION: "2.8"
    test:
    - as: ovs-timeout-validation
      cli: latest
      commands: "#!/bin/bash\nset -euo pipefail\n\n# OVS Timeout Fix Validation for
        OCPBUGS-66075\n# Tests the 90-second OVS timeout fix under high concurrent
        pod creation load\n\necho \"Starting OVS Timeout Fix Validation for OCPBUGS-66075\"\necho
        \"Testing OVS timeout increase from 30s to 90s in HyperShift HCP environment\"\necho
        \"Using custom release: registry.build07.ci.openshift.org/ci-ln-l477g5k/release:latest\"\necho
        \"Target pods: 1000\"\n\n# Function to log with timestamp\nlog() {\n  echo
        \"[$(date '+%Y-%m-%d %H:%M:%S')] [OCPBUGS-66075] $*\"\n}\n\nlog \"Creating
        test deployment with 1000 pods...\"\n\n# Create the stress test deployment\ncat
        <<EOF | oc apply -f -\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n
        \ name: ovs-timeout-test-deployment\n  namespace: default\n  labels:\n    app:
        ovs-timeout-test\n    test-id: \"OCPBUGS-66075\"\n    test-purpose: \"ovs-timeout-validation\"\n
        \ annotations:\n    test.openshift.io/description: \"OVS timeout fix validation
        for OCPBUGS-66075\"\n    test.openshift.io/expected-timeout: \"90s\"\n    test.openshift.io/custom-release:
        \"registry.build07.ci.openshift.org/ci-ln-l477g5k/release:latest\"\nspec:\n
        \ replicas: 1000\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n
        \     maxSurge: 500\n      maxUnavailable: 0\n  selector:\n    matchLabels:\n
        \     app: ovs-timeout-test\n  template:\n    metadata:\n      labels:\n        app:
        ovs-timeout-test\n        test-phase: \"concurrent-pod-creation\"\n    spec:\n
        \     terminationGracePeriodSeconds: 5\n      containers:\n      - name: test-container\n
        \       image: registry.access.redhat.com/ubi8/ubi-minimal:latest\n        command:\n
        \       - /bin/bash\n        - -c\n        - |\n          echo \"Pod \\${HOSTNAME}
        started at \\$(date)\"\n          echo \"Testing OVS timeout fix for OCPBUGS-66075\"\n
        \         echo \"Expected OVS timeout: 90 seconds (was 30 seconds)\"\n          while
        true; do\n            echo \"Pod \\${HOSTNAME} alive at \\$(date)\"\n            sleep
        600\n          done\n        resources:\n          requests:\n            memory:
        \"32Mi\"\n            cpu: \"5m\"\n          limits:\n            memory:
        \"64Mi\"\n            cpu: \"10m\"\n        env:\n        - name: POD_NAME\n
        \         valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n
        \       - name: NODE_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath:
        spec.nodeName\n      restartPolicy: Always\nEOF\n\nlog \"Monitoring pod creation
        progress...\"\n\nstart_time=$(date +%s)\nmax_pods_ready=0\ntimeout_errors=0\n\n#
        Monitor for up to MAX_WAIT seconds\nwhile true; do\n  current_time=$(date
        +%s)\n  elapsed=$((current_time - start_time))\n  \n  if [ $elapsed -gt 2400
        ]; then\n    log \"ERROR: Test timed out after 2400 seconds\"\n    break\n
        \ fi\n  \n  # Get pod statistics\n  running_pods=$(oc get pods -l app=ovs-timeout-test
        --no-headers 2>/dev/null | grep \"Running\" | wc -l || echo 0)\n  pending_pods=$(oc
        get pods -l app=ovs-timeout-test --no-headers 2>/dev/null | grep -E \"Pending|ContainerCreating\"
        | wc -l || echo 0)\n  failed_pods=$(oc get pods -l app=ovs-timeout-test --no-headers
        2>/dev/null | grep -vE \"Running|Pending|ContainerCreating\" | wc -l || echo
        0)\n  \n  # Track maximum pods reached\n  if [ $running_pods -gt $max_pods_ready
        ]; then\n    max_pods_ready=$running_pods\n  fi\n  \n  # Check for OVS timeout
        errors\n  new_timeout_errors=$(oc get events --field-selector reason=FailedCreatePodSandBox
        -o json 2>/dev/null | \\\n    jq -r '[.items[] | select(.message | test(\"timeout.*ovs|ovs.*timeout|timeout.*30|timeout.*90\",
        \"i\"))] | length' 2>/dev/null || echo 0)\n  timeout_errors=$new_timeout_errors\n
        \ \n  log \"Progress: ${running_pods}/1000 Running, ${pending_pods} Pending,
        ${failed_pods} Failed | Time: ${elapsed}s | Timeout Errors: ${timeout_errors}\"\n
        \ \n  # Success condition\n  if [ $running_pods -eq 1000 ]; then\n    log
        \"SUCCESS: All 1000 pods are running!\"\n    break\n  fi\n  \n  # Check for
        high failure rate\n  if [ $failed_pods -gt $((1000 / 4)) ]; then\n    log
        \"ERROR: High failure rate detected: ${failed_pods} failed pods\"\n    break\n
        \ fi\n  \n  sleep 15\ndone\n\n# Final results and cleanup\nend_time=$(date
        +%s)\ntotal_elapsed=$((end_time - start_time))\n\nlog \"=== FINAL TEST RESULTS
        ===\"\nlog \"Custom Release: registry.build07.ci.openshift.org/ci-ln-l477g5k/release:latest\"\nlog
        \"Target pods: 1000\"\nlog \"Maximum pods running: ${max_pods_ready}\"\nlog
        \"Final running pods: ${running_pods}\"\nlog \"Failed pods: ${failed_pods}\"\nlog
        \"Total elapsed time: ${total_elapsed} seconds\"\nlog \"OVS timeout errors:
        ${timeout_errors}\"\n\n# Collect debug info\necho \"=== Recent Events ===\"\noc
        get events --sort-by='.lastTimestamp' | tail -30\n\necho \"=== Node Resources
        ===\"\noc adm top nodes || echo \"Node metrics not available\"\n\n# Cleanup\nlog
        \"Cleaning up test deployment...\"\noc delete deployment ovs-timeout-test-deployment
        --ignore-not-found=true --timeout=120s\n\n# Determine test result\nsuccess_threshold=$((1000
        * 85 / 100))  # 85% success rate\n\nif [ $timeout_errors -eq 0 ] && [ $max_pods_ready
        -ge $success_threshold ]; then\n  log \"\U0001F389 TEST RESULT: PASSED ✅\"\n
        \ log \"✅ Zero OVS timeout errors - 90s timeout fix is working\"\n  log \"✅
        Successfully created ${max_pods_ready} concurrent pods (≥${success_threshold}
        required)\"\n  exit 0\nelse\n  log \"\U0001F4A5 TEST RESULT: FAILED ❌\"\n
        \ if [ $timeout_errors -gt 0 ]; then\n    log \"❌ Found ${timeout_errors}
        OVS timeout errors\"\n  fi\n  if [ $max_pods_ready -lt $success_threshold
        ]; then\n    log \"❌ Only reached ${max_pods_ready} pods (required ≥${success_threshold})\"\n
        \ fi\n  exit 1\nfi\n"
      from: test-bin
      resources:
        requests:
          cpu: 100m
          memory: 200Mi
    workflow: openshift-qe-installer-hypershift-mce-agent-metal3
zz_generated_metadata:
  branch: main
  org: openshift-eng
  repo: ocp-qe-perfscale-ci
  variant: hypershift_bm-4.18-nightly-x86
