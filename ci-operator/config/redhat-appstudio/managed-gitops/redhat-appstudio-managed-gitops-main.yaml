base_images:
  cli:
    name: "4.12"
    namespace: ocp
    tag: cli
binary_build_commands: make bin
build_root:
  project_image:
    dockerfile_path: .ci/base-image/Dockerfile
images:
- context_dir: /
  dockerfile_path: Dockerfile.ci
  from: src
  inputs:
    cli:
      paths:
      - destination_dir: .
        source_path: /usr/bin/oc
  to: gitops-service-image
releases:
  latest:
    release:
      architecture: amd64
      channel: fast
      version: "4.12"
resources:
  '*':
    limits:
      memory: 4Gi
    requests:
      cpu: 100m
      memory: 200Mi
tests:
- as: managed-gitops-e2e-tests
  cluster_claim:
    architecture: amd64
    cloud: aws
    owner: openshift-ci
    product: ocp
    timeout: 2h0m0s
    version: "4.12"
  steps:
    test:
    - as: managed-gitops-e2e-step
      commands: scripts/openshiftci-presubmit-e2e-tests.sh
      credentials:
      - mount_path: /var/run/github-username
        name: github-username
        namespace: test-credentials
      - mount_path: /var/run/github-pat
        name: github-pat
        namespace: test-credentials
      dependencies:
      - env: CI_IMAGE
        name: gitops-service-image
      env:
      - default: /var/run/github-username/github-username
        name: GITHUB_USERNAME
      - default: /var/run/github-pat/github-pat
        name: GITHUB_PERSONAL_ACCESS_TOKEN
      from: src
      resources:
        requests:
          cpu: 100m
    workflow: generic-claim
- as: managed-gitops-e2e-tests-upgrade
  cluster_claim:
    architecture: amd64
    cloud: aws
    owner: openshift-ci
    product: ocp
    timeout: 1h0m0s
    version: "4.12"
  steps:
    test:
    - as: managed-gitops-e2e-tests-upgrade
      cli: latest
      commands: |
        working_dir=$(pwd)
        tmp_dir=$(mktemp -d -t temp-repo-XXXXXXXXXX)
        chmod +x $tmp_dir

        #execute test on main
        git clone https://github.com/redhat-appstudio/managed-gitops.git $tmp_dir #main branch
        cd $tmp_dir
        echo "******* install argocd-openshift *********"
        make install-argocd-openshift
        make devenv-k8s
        make download-deps
        kubectl port-forward --namespace gitops svc/gitops-postgresql-staging 5432:5432 &
        PORT_FORWARD_PID=$!
        make start-e2e &
        echo "******** Waiting (30 sec) Service **********" && sleep 30
        echo "[STARTING BACKWARD COMPATIBILITY TEST - MAIN ]"
        make check-backward-compatibility
        echo "End Port Forwarding"
        kill $PORT_FORWARD_PID
        killall kubectl || true
        killall goreman || true

        #execute test on PR branch (current)
        cd $working_dir
        echo "******* install argocd-openshift *********"
        make install-argocd-openshift
        make devenv-k8s
        make download-deps
        kubectl port-forward --namespace gitops svc/gitops-postgresql-staging 5432:5432 &
        PORT_FORWARD_PID=$!
        make start-e2e &
        echo "******** Waiting (30 sec) Service **********" && sleep 30
        echo "[STARTING BACKWARD COMPATIBILITY TEST - NEW BRANCH]"
        make check-backward-compatibility
        echo "End Port Forwarding"
        kill $PORT_FORWARD_PID
        killall kubectl || true
        killall goreman || true

        #cleanup - delete temp repo
        rm -rf $tmp_dir
      from: src
      resources:
        requests:
          cpu: 1000m
    workflow: generic-claim
zz_generated_metadata:
  branch: main
  org: redhat-appstudio
  repo: managed-gitops
