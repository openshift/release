base_images:
  dev-scripts:
    name: test
    namespace: ocp-kni
    tag: dev-scripts
binary_build_commands: make build
build_root:
  from_repository: true
canonical_go_repository: github.com/openshift/cluster-api-provider-metal3
images:
- dockerfile_path: Dockerfile.ocp
  to: baremetal-cluster-api-controllers
promotion:
  to:
  - name: 4.22-priv
    namespace: ocp-private
releases:
  initial:
    integration:
      name: 4.22-priv
      namespace: ocp-private
  latest:
    integration:
      include_built_images: true
      name: 4.22-priv
      namespace: ocp-private
resources:
  '*':
    limits:
      memory: 4Gi
    requests:
      cpu: 100m
      memory: 200Mi
test_binary_build_commands: make unit
tests:
- as: unit
  commands: make unit
  container:
    from: src
  skip_if_only_changed: (^(docs|examples|config)/)|(\.md$)|((^|/)OWNERS$)
- as: vendor
  commands: make vendor && git diff --exit-code
  container:
    from: src
  run_if_changed: (go\.(mod|sum)$)|(^(apis|pkg/hardwareutils)/)
- as: lint
  commands: export GOLANGCI_LINT_CACHE=/tmp/.cache make
  container:
    from: src
  skip_if_only_changed: (^(docs|examples)/)|(\.md$)|((^|/)OWNERS$)
- as: verify-deps
  steps:
    env:
      CHECK_MOD_LIST: "false"
    test:
    - ref: go-verify-deps
- as: verify
  commands: make -C openshift verify
  container:
    from: src
- always_run: false
  as: e2e-metal3-capi-techpreview
  capabilities:
  - intranet
  steps:
    cluster_profile: equinix-ocp-metal
    env:
      DEVSCRIPTS_CONFIG: |
        BMO_WATCH_ALL_NAMESPACES="true"
        NUM_EXTRA_WORKERS=1
        EXTRA_WORKERS_NAMESPACE=openshift-cluster-api
        FEATURE_SET=TechPreviewNoUpgrade
        ENABLE_CAPI_E2E="true"
    test:
    - as: test
      commands: |
        source "${SHARED_DIR}/packet-conf.sh"
        # POC fix: strip resourceVersion/uid/creationTimestamp from secret before applying
        # The error "object has been modified" is an optimistic concurrency error caused by
        # these metadata fields being copied from the source secret
        ssh "${SSHOPTS[@]}" "root@${IP}" "sed -i 's#oc apply -f -#sed -e \"/^  resourceVersion:/d\" -e \"/^  uid:/d\" -e \"/^  creationTimestamp:/d\" | oc apply -f -#g' /root/dev-scripts/setup_capi_e2e.sh"
        ssh "${SSHOPTS[@]}" "root@${IP}" "cd /root/dev-scripts && make capi_e2e"
      from: dev-scripts
      resources:
        requests:
          cpu: 100m
    workflow: baremetalds-e2e-ovn-ipv6
zz_generated_metadata:
  branch: main
  org: openshift-priv
  repo: cluster-api-provider-metal3
