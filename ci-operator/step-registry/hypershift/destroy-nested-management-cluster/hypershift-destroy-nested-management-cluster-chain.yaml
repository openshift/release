chain:
  as: hypershift-destroy-nested-management-cluster
  steps:
  - as: dump-management-cluster
    optional_on_success: true
    cli: latest
    env:
    - name: HYPERSHIFT_NAMESPACE
      default: "clusters"
      documentation: "The Namespace where to create the HostedCluster and NodePools"
    - name: CLOUD_PROVIDER
      default: "AWS"
      documentation: "The cloud provider of the cluster."
    commands: |-
      # Set cloud-specific kubeconfig
      if [[ "${CLOUD_PROVIDER}" == "Azure" ]]; then
        export KUBECONFIG=/etc/hypershift-kubeconfig-azure/hypershift-ops-admin.kubeconfig
      else
        export KUBECONFIG=/etc/hypershift-kubeconfig/hypershift-ops-admin.kubeconfig
      fi

      CLUSTER_NAME="$(echo -n $PROW_JOB_ID|sha256sum|cut -c-20)-mgmt"
      mkdir -p "${ARTIFACT_DIR}/output"
      bin/hypershift dump cluster --dump-guest-cluster=true --artifact-dir="${ARTIFACT_DIR}/output" --name="${CLUSTER_NAME}" --namespace="${HYPERSHIFT_NAMESPACE}"
      tar -cvzf "${ARTIFACT_DIR}/artifacts.tar.gz" "${ARTIFACT_DIR}/output"
      rm -rf "${ARTIFACT_DIR}/output"
    credentials:
    - mount_path: /etc/hypershift-kubeconfig
      name: hypershift-ci-2
      namespace: test-credentials
    - mount_path: /etc/hypershift-kubeconfig-azure
      name: azure-hypershift-ci
      namespace: test-credentials
    from_image:
      namespace: hypershift
      name: hypershift-operator
      tag: latest
    grace_period: 15m0s
    resources:
      requests:
        cpu: 100m
  - ref: hypershift-dump-extra
  - as: destroy-management-cluster
    cli: latest
    env:
      - name: HYPERSHIFT_NAMESPACE
        default: "clusters"
        documentation: "The Namespace where to create the HostedCluster and NodePools"
      - name: HYPERSHIFT_GUEST_INFRA_OCP_ACCOUNT
        default: "false"
        documentation: "Whether to use the generic CI account or the HyperShift OSD account for the guest clusters infra. For the infra created for the clusters. E.g. For cluster-bot we use the generic CI account"
      - name: HYPERSHIFT_BASE_DOMAIN
        default: ""
        documentation: "The cluster's FQDN will be a subdomain of the base domain."
      - name: HYPERSHIFT_AZURE_LOCATION
        default: "centralus"
        documentation: "The Azure location for the cluster (only used when CLOUD_PROVIDER=Azure)"
      - name: CLOUD_PROVIDER
        default: "AWS"
        documentation: "The cloud provider to use for the management cluster"
    commands: |-
      # Set cloud-specific defaults
      if [[ "${CLOUD_PROVIDER}" == "Azure" ]]; then
        export KUBECONFIG=/etc/hypershift-kubeconfig-azure/hypershift-ops-admin.kubeconfig
        AZURE_GUEST_INFRA_CREDENTIALS_FILE="/etc/hypershift-ci-jobs-self-managed-azure/credentials.json"
        DEFAULT_BASE_DOMAIN=hypershift.azure.devcluster.openshift.com
      else
        AWS_GUEST_INFRA_CREDENTIALS_FILE="/etc/hypershift-ci-jobs-awscreds/credentials"
        DEFAULT_BASE_DOMAIN=ci.hypershift.devcluster.openshift.com
        export KUBECONFIG=/etc/hypershift-kubeconfig/hypershift-ops-admin.kubeconfig

        if [[ $HYPERSHIFT_GUEST_INFRA_OCP_ACCOUNT == "true" ]]; then
          AWS_GUEST_INFRA_CREDENTIALS_FILE="${CLUSTER_PROFILE_DIR}/.awscred"
          DEFAULT_BASE_DOMAIN=origin-ci-int-aws.dev.rhcloud.com
        fi
      fi

      DOMAIN=${HYPERSHIFT_BASE_DOMAIN:-$DEFAULT_BASE_DOMAIN}
      CLUSTER_NAME="$(echo -n $PROW_JOB_ID|sha256sum|cut -c-20)-mgmt"

      # Destroy the management cluster based on cloud provider
      if [[ "${CLOUD_PROVIDER}" == "Azure" ]]; then
        echo "Destroying Azure management cluster ${CLUSTER_NAME}"
        bin/hypershift destroy cluster azure \
          --azure-creds=${AZURE_GUEST_INFRA_CREDENTIALS_FILE} \
          --name="${CLUSTER_NAME}" \
          --namespace="${HYPERSHIFT_NAMESPACE}" \
          --location=${HYPERSHIFT_AZURE_LOCATION} \
          --cluster-grace-period 40m
      else
        echo "Destroying AWS management cluster ${CLUSTER_NAME}"
        bin/hypershift destroy cluster aws \
          --aws-creds=${AWS_GUEST_INFRA_CREDENTIALS_FILE} \
          --name="${CLUSTER_NAME}" \
          --namespace="${HYPERSHIFT_NAMESPACE}" \
          --infra-id=${CLUSTER_NAME} \
          --base-domain=${DOMAIN} \
          --cluster-grace-period 40m
      fi
    credentials:
    - mount_path: /etc/hypershift-ci-jobs-awscreds
      name: hypershift-ci-jobs-awscreds
      namespace: test-credentials
    - mount_path: /etc/hypershift-kubeconfig
      name: hypershift-ci-2
      namespace: test-credentials
    - mount_path: /etc/hypershift-kubeconfig-azure
      name: azure-hypershift-ci
      namespace: test-credentials
    - mount_path: /etc/hypershift-ci-jobs-self-managed-azure
      name: hypershift-ci-jobs-self-managed-azure
      namespace: test-credentials
    from_image:
      namespace: hypershift
      name: hypershift-operator
      tag: latest
    grace_period: 15m0s
    resources:
      requests:
        cpu: 100m
