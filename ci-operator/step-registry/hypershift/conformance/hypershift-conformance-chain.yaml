chain:
  as: hypershift-conformance
  steps:
  - as: conformance-tests
    from: tests
    commands: |-
      CLUSTER_NAME="$(echo -n $PROW_JOB_ID|sha256sum|cut -c-20)"
      export HYPERSHIFT_MANAGEMENT_CLUSTER_KUBECONFIG="${KUBECONFIG}"
      export HYPERSHIFT_MANAGEMENT_CLUSTER_NAMESPACE="$(oc get hcp -A -o=jsonpath="{.items[?(@.metadata.name==\"$CLUSTER_NAME\")].metadata.namespace}")"
      export AWS_SHARED_CREDENTIALS_FILE=/etc/hypershift-pool-aws-credentials/credentials
      export PLATFORM_FAILURE_CONDITION=""
      [[ -n ${CLUSTER_PROFILE_DIR:-} ]] && export AZURE_AUTH_LOCATION=${CLUSTER_PROFILE_DIR}/osServicePrincipal.json
      export KUBECONFIG=${SHARED_DIR}/nested_kubeconfig
      if [ -f "${SHARED_DIR}/proxy-conf.sh" ] ; then
        source "${SHARED_DIR}/proxy-conf.sh"
      fi

      CLUSTER_TYPE="$(oc get infrastructure cluster -ojsonpath='{.status.platform}'|tr '[:upper:]' '[:lower:]')"
      case "${CLUSTER_TYPE}" in
      gcp)
          PROJECT="$(oc get -o jsonpath='{.status.platformStatus.gcp.projectID}' infrastructure cluster)"
          REGION="$(oc get -o jsonpath='{.status.platformStatus.gcp.region}' infrastructure cluster)"
          export TEST_PROVIDER="{\"type\":\"gce\",\"region\":\"${REGION}\",\"multizone\": true,\"multimaster\":true,\"projectid\":\"${PROJECT}\"}"
          ;;
      aws|aws-arm64)
          REGION="$(oc get -o jsonpath='{.status.platformStatus.aws.region}' infrastructure cluster)"
          ZONE="$(oc get -o jsonpath='{.items[0].metadata.labels.failure-domain\.beta\.kubernetes\.io/zone}' nodes)"
          export TEST_PROVIDER="{\"type\":\"aws\",\"region\":\"${REGION}\",\"zone\":\"${ZONE}\",\"multizone\":true,\"multimaster\":true}"
          ;;
      azure4|azure) export TEST_PROVIDER=azure;;
      azurestack)
          export TEST_PROVIDER="none"
          ;;
      vsphere)
          export TEST_PROVIDER=vsphere;;
      alibabacloud)
          REGION="$(oc get -o jsonpath='{.status.platformStatus.alibabacloud.region}' infrastructure cluster)"
          export TEST_PROVIDER="{\"type\":\"alibabacloud\",\"region\":\"${REGION}\",\"multizone\":true,\"multimaster\":true}"
          export KUBE_SSH_USER=core
      ;;
      openstack*)
          # shellcheck disable=SC1090
          source "${SHARED_DIR}/cinder_credentials.sh"
          if test -n "${HTTP_PROXY:-}" -o -n "${HTTPS_PROXY:-}"; then
              export TEST_PROVIDER='{"type":"openstack","disconnected":true}'
          else
              export TEST_PROVIDER='{"type":"openstack"}'
          fi
          ;;
      ovirt) export TEST_PROVIDER='{"type":"ovirt"}';;
      none)
          export TEST_PROVIDER='{"type":"baremetal","disconnected":true}'
          ;;
      ibmcloud)
          export TEST_PROVIDER='{"type":"ibmcloud"}'
          IC_API_KEY="$(< "${CLUSTER_PROFILE_DIR}/ibmcloud-api-key")"
          export IC_API_KEY
          ;;
      kubevirt)
          export TEST_PROVIDER='{"type":"kubevirt"}'

          # This looks counterintuitive. Here's an explanation.
          #
          # There technically isn't a parallel minimal test suite. Some of the older KubeVirt
          # platform versions need to be limited to just to tests marked as minimal.
          #
          # By using the "openshift/conformance/parallel" test suite, but filtering out
          # everything that matches exactly to the "openshift/conformance/parallel" test suite,
          # we are left with just the "openshift/conformance/parallel/minimal" test entries.
          #
          # This might not be the best long term solution, but these older KubeVirt platform
          # tests won't be maintained for long and are not a part of any GA.

          PIPE="\|"
          # if $TEST_SKIPS is empty then $PIPE should be empty too
          if [[ -z "$TEST_SKIPS" ]]; then
            PIPE=""          
          fi
          if [[ "${TEST_SUITE}" == "openshift/conformance/parallel/minimal" ]]; then
              TEST_SKIPS=$TEST_SKIPS"${PIPE}\[Suite:openshift/conformance/parallel\]"
              TEST_SUITE="openshift/conformance/parallel"
          fi

          ;;
      *) echo >&2 "Unsupported cluster type '${CLUSTER_TYPE}'"; exit 1;;
      esac

      if [[ -n "${TEST_SKIPS}" ]]; then
          TESTS="$(openshift-tests run --dry-run --provider "${TEST_PROVIDER}" "${TEST_SUITE}")"
          echo "${TESTS}" | grep -v "${TEST_SKIPS}" >/tmp/tests
          echo "Skipping tests:"
          echo "${TESTS}" | grep "${TEST_SKIPS}" || { exit_code=$?; echo 'Error: no tests were found matching the TEST_SKIPS regex:'; echo "$TEST_SKIPS"; return $exit_code; }
          TEST_ARGS="${TEST_ARGS:-} --file /tmp/tests"
      fi

      openshift-tests run ${TEST_SUITE} ${TEST_ARGS:-} \
        --provider "${TEST_PROVIDER}" \
        -o "${ARTIFACT_DIR}/e2e.log" \
        --junit-dir "${ARTIFACT_DIR}/junit" 2>&1 | tee /tmp/openshift-tests.log
      
      exit_code=${PIPESTATUS[0]}
                
      # If this line is shown in the openshift-tests output, all of the conformance test cases passed,
      # but the monitor test has failed. Currently we're ignoring MonitorTest failures until we resolve:
      # https://issues.redhat.com/browse/CNV-33717
      if [[ -n "${SKIP_MONITOR_TEST}" ]] && [[ $(grep "failed due to a MonitorTest failure" /tmp/openshift-tests.log) ]];
      then
        echo "overriding Monitor Test Failure"
        exit_code=0
      fi

      # Platform specific additional testing
      #
      # If a platform needs to run additional conformance testing that encompasses
      # additional test suites, that can be executed per platform in the switch case
      # below. If a failure is detected, set the PLATFORM_FAILURE_CONDITION env var
      # with a human readable msg discribing the failure. Ensure test artifacts
      # are placed in a separat $ARTIFACTS sub directory.
      case "${CLUSTER_TYPE}" in
      kubevirt)
          ###
          # START KubeVirt CSI Conformance Test Execution
          ###
          # CSI driver env vars
          export TEST_CSI_DRIVER_MANIFEST="kubevirt-driver.yaml"
          curl -L -o ${SHARED_DIR}/${TEST_CSI_DRIVER_MANIFEST} https://raw.githubusercontent.com/openshift/kubevirt-csi-driver/master/hack/test-driver.yaml
          sed -i 's/FromExistingClassName: kubevirt/FromExistingClassName: kubevirt-csi-infra-default/' ${SHARED_DIR}/${TEST_CSI_DRIVER_MANIFEST}
          export TEST_CSI_DRIVER_FILES=${SHARED_DIR}/${TEST_CSI_DRIVER_MANIFEST}

          openshift-tests run --dry-run --provider "${TEST_PROVIDER}" openshift/csi | grep -e "External.Storage.*csi.kubevirt.io.*" | grep -v "CSI Ephemeral-volume*" > /tmp/tests_hs_kv_csi
          CSI_TEST_ARGS="${TEST_ARGS:-} --max-parallel-tests 1 --file /tmp/tests_hs_kv_csi"

          # Make sure the csi artifacts can be stored
          mkdir -p "${ARTIFACT_DIR}/csi"
          cp "${SHARED_DIR}/${TEST_CSI_DRIVER_MANIFEST}" "${ARTIFACT_DIR}/csi/kubevirt-driver.yaml"

          openshift-tests run openshift/csi ${CSI_TEST_ARGS:-} \
            --provider "${TEST_PROVIDER}" \
            -o "${ARTIFACT_DIR}/csi/e2e.log" \
            --junit-dir "${ARTIFACT_DIR}/csi/junit" 2>&1 | tee /tmp/openshift-csi-tests.log

          csi_exit_code=${PIPESTATUS[0]}

          # If this line is shown in the openshift-tests output, all of the conformance test cases passed,
          # but the monitor test has failed. Currently we're ignoring MonitorTest failures until we resolve:
          # https://issues.redhat.com/browse/CNV-33717
          if [[ -n "${SKIP_MONITOR_TEST}" ]] && [[ $(grep "failed due to a MonitorTest failure" /tmp/openshift-csi-tests.log) ]];
          then
            echo "overriding Monitor Test Failure in CSI tests"
            csi_exit_code=0
          fi

          if [[ csi_exit_code -ne 0 ]]; then
            echo "CSI conformance test exit code ${csi_exit_code}"
            PLATFORM_FAILURE_CONDITION="KubeVirt CSI conformance tests returned failure(s)"
          fi
          ###
          # END KubeVirt CSI Conformance Test Execution
          ###
          ;;
      esac

      if [ -n "$PLATFORM_FAILURE_CONDITION" ]; then
        echo "Cluster type $CLUSTER_TYPE encountered a failure condition: $PLATFORM_FAILURE_CONDITION"
        exit_code=1
      fi

      exit ${exit_code}
    credentials:
    - mount_path: /etc/hypershift-pool-aws-credentials
      name: hypershift-pool-aws-credentials
      namespace: test-credentials
    timeout: 6h
    env:
    - name: TEST_ARGS
      default: ""
      documentation: |-
        Additional arguments to be passed to 'openshift-test'
    - name: TEST_SUITE
      default: openshift/conformance/parallel
      documentation: |-
        The test suite to run. Defaults to openshift/conformance/parallel
    - name: TEST_SKIPS
      default: ""
      documentation: |
        Regular expression (POSIX basic regular expression) of tests to skip.
        It is suggested to test the regex to make sure that it matches with the available tests.
        Tests can be listed by using 'openshift-tests run --dry-run (...)'. Sometimes, the tests
        that are printed in Prow won't exactly match the list returned by openshift-tests.
    - name: SKIP_MONITOR_TEST
      default: ""
      documentation: |-
        if non-empty, ignores job failure which is as a result of a failure of the MonitorTest suite.
        All conformance test cases need to pass for the job to pass, though.
    resources:
      requests:
        cpu: "3"
        memory: 600Mi
