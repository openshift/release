chain:
  as: hypershift-azure-create
  steps:
  - as: create-hostedcluster
    cli: latest
    env:
    - name: HYPERSHIFT_NODE_COUNT
      default: "3"
      documentation: "The number nodes to automatically create and join to the cluster."
    - name: HYPERSHIFT_BASE_DOMAIN
      default: "ci.azure.devcluster.openshift.com"
      documentation: "The cluster's FQDN will be a subdomain of the base domain."
    - name: HYPERSHIFT_HC_RELEASE_IMAGE
      default: ""
      documentation: "Release image used for the HostedCluster. Empty by default it will use release:latest"
    - name: HYPERSHIFT_AZURE_LOCATION
      default: "eastus"
      documentation: "The Azure location of the cluster."
    - name: CONTROLPLANE_OPERATOR_IMAGE
      default: ""
      documentation: "The CPO image to use. Set to LATEST to use the latest one"
    - name: USE_HYPERSHIFT_AZURE_CREDS
      default: "false"
      documentation: "Whether to use hypershift-ci-jobs-azurecreds secret for Azure credentials. Set to 'true' to use the secret. Set to 'false' to use the default credentials."
    commands: |-
      set -exuo pipefail

      CLUSTER_NAME="$(echo -n $PROW_JOB_ID|sha256sum|cut -c-20)"
      echo "$(date) Creating HyperShift cluster ${CLUSTER_NAME}"
      
      RELEASE_IMAGE=${HYPERSHIFT_HC_RELEASE_IMAGE:-$RELEASE_IMAGE_LATEST}
      
      AZURE_CREDS=${CLUSTER_PROFILE_DIR}/osServicePrincipal.json
      
      # We don't have the value of HYPERSHIFT_RELEASE_LATEST when we set CONTROLPLANE_OPERATOR_IMAGE so we
      # have to use a hack like this.
      [[ ${CONTROLPLANE_OPERATOR_IMAGE} = "LATEST" ]] && CONTROLPLANE_OPERATOR_IMAGE="${HYPERSHIFT_RELEASE_LATEST}"
      
      
      CLUSTER_IMAGE_FLAGS="--release-image ${RELEASE_IMAGE} --control-plane-operator-image=${CONTROLPLANE_OPERATOR_IMAGE:-}"
      
      if [[ "${USE_HYPERSHIFT_AZURE_CREDS:-}" == 'true' ]]; then
        export AZURE_CREDS="/etc/hypershift-ci-jobs-azurecreds/credentials.json"
        export CLUSTER_IMAGE_FLAGS="--release-stream=4.16.0-0.nightly"
      fi
      
      /usr/bin/hypershift create cluster azure \
        --name ${CLUSTER_NAME} \
        --node-pool-replicas ${HYPERSHIFT_NODE_COUNT} \
        --base-domain ${HYPERSHIFT_BASE_DOMAIN} \
        --pull-secret=/etc/ci-pull-credentials/.dockerconfigjson \
        --azure-creds=${AZURE_CREDS} \
        --location ${HYPERSHIFT_AZURE_LOCATION} \
        --infra-id=${CLUSTER_NAME} \
        --annotations=hypershift.openshift.io/skip-release-image-validation=true ${CLUSTER_IMAGE_FLAGS}

      # The timeout should be much lower, this is due to https://bugzilla.redhat.com/show_bug.cgi?id=2060091
      echo "Waiting for cluster to become available"
      oc wait --timeout=30m --for=condition=Available --namespace=clusters hostedcluster/${CLUSTER_NAME}
      echo "Cluster became available, creating kubeconfig"
      bin/hypershift create kubeconfig --namespace=clusters --name=${CLUSTER_NAME} >${SHARED_DIR}/nested_kubeconfig
      echo "Waiting for clusteroperators to be ready"
      export KUBECONFIG=${SHARED_DIR}/nested_kubeconfig
      until \
        oc wait clusterversion/version --for='condition=Available=True' > /dev/null;  do
          echo "$(date --rfc-3339=seconds) Clusteroperators not yet ready"
          oc get clusterversion 2>/dev/null || true
          sleep 1s
      done
    from: hypershift-operator
    grace_period: 5m0s
    resources:
      requests:
        cpu: 100m
        memory: 100Mi
    timeout: 45m0s
    credentials:
    - mount_path: /etc/hypershift-ci-jobs-azurecreds
      name: hypershift-ci-jobs-azurecreds
      namespace: test-credentials
    - mount_path: /etc/ci-pull-credentials
      name: ci-pull-credentials
      namespace: test-credentials
    dependencies:
    - name: "release:latest"
      env: RELEASE_IMAGE_LATEST
