chain:
  as: hypershift-azure-setup-nested-management-cluster
  steps:
    - as: create-management-cluster
      cli: latest
      env:
        - name: HYPERSHIFT_NODE_COUNT
          default: "3"
          documentation: "The number nodes for the cluster."
        - name: HYPERSHIFT_INSTANCE_TYPE
          default: "Standard_D4s_v4"
          documentation: "Instance type for the cluster nodes"
        - name: HYPERSHIFT_NAMESPACE
          default: "clusters"
          documentation: "The Namespace where to create the HostedCluster and NodePools"
        - name: HYPERSHIFT_BASE_DOMAIN
          default: ""
          documentation: "The cluster's FQDN will be a subdomain of the base domain."
      commands: |-
        DEFAULT_BASE_DOMAIN="hypershift.azure.devcluster.openshift.com"
        
        DOMAIN=${HYPERSHIFT_BASE_DOMAIN:-$DEFAULT_BASE_DOMAIN}
        
        DEFAULT_RELEASE_STREAM=4.16.0-0.nightly
        
        export KUBECONFIG=/etc/hypershift-kubeconfig/hypershift-ops-admin.kubeconfig
        CLUSTER_NAME="$(echo -n $PROW_JOB_ID|sha256sum|cut -c-20)-mgmt"
        bin/hypershift create cluster azure \
          --pull-secret=/etc/ci-pull-credentials/.dockerconfigjson \
          --azure-creds="/etc/hypershift-ci-jobs-azurecreds/credentials.json" \
          --name=${CLUSTER_NAME} \
          --location=eastus \
          --infra-id=${CLUSTER_NAME} \
          --base-domain=${DOMAIN} \
          --instance-type=${HYPERSHIFT_INSTANCE_TYPE} \
          --service-cidr=172.29.0.0/16 \
          --node-pool-replicas=${HYPERSHIFT_NODE_COUNT} \
          --release-stream=${DEFAULT_RELEASE_STREAM} \
          --namespace=${HYPERSHIFT_NAMESPACE} \
          --annotations resource-request-override.hypershift.openshift.io/kube-apiserver.kube-apiserver=memory=3Gi,cpu=2000m
        echo "Waiting for cluster to become available"
        oc wait --timeout=10m --for=condition=Available --namespace=${HYPERSHIFT_NAMESPACE} hostedcluster/${CLUSTER_NAME}
        echo "Cluster became available, creating kubeconfig"
        
        # Data for cluster bot.
        # The kubeadmin-password secret is reconciled only after the kas is available so giving a few seconds to avoid racing and move forward otherwise. 
        sleep 15
        echo "Getting ${CLUSTER_NAME}-kubeadmin-password from namespace ${HYPERSHIFT_NAMESPACE}"
        until \
          oc get secret -n${HYPERSHIFT_NAMESPACE} ${CLUSTER_NAME}-kubeadmin-password 2> /dev/null; do
            echo "$(date --rfc-3339=seconds) kubeadmin password not yet available"
            sleep 5
        done
        oc get secret -n${HYPERSHIFT_NAMESPACE} ${CLUSTER_NAME}-kubeadmin-password --template={{.data.password}} | base64 -d > ${SHARED_DIR}/kubeadmin-password
        
        bin/hypershift create kubeconfig --namespace=${HYPERSHIFT_NAMESPACE} --name=${CLUSTER_NAME} >${SHARED_DIR}/management_cluster_kubeconfig
        bin/hypershift create kubeconfig --namespace=${HYPERSHIFT_NAMESPACE} --name=${CLUSTER_NAME} >${SHARED_DIR}/kubeconfig
        echo "${HYPERSHIFT_NAMESPACE}" > ${SHARED_DIR}/management_cluster_namespace
        echo "${CLUSTER_NAME}" > ${SHARED_DIR}/management_cluster_name
        echo "Waiting for clusteroperators to be ready"
        export KUBECONFIG=${SHARED_DIR}/management_cluster_kubeconfig
        until \
          oc wait clusterversion/version --for='condition=Available=True' > /dev/null; do
            echo "$(date --rfc-3339=seconds) Clusteroperators not yet ready"
            oc get clusterversion 2>/dev/null || true
            sleep 1s
        done
        # Data for cluster bot.
        echo "https://$(oc -n openshift-console get routes console -o=jsonpath='{.spec.host}')" > "${SHARED_DIR}/console.url"
      credentials:
        - mount_path: /etc/hypershift-ci-jobs-azurecreds
          name: hypershift-ci-jobs-azurecreds
          namespace: test-credentials
        - mount_path: /etc/ci-pull-credentials
          name: ci-pull-credentials
          namespace: test-credentials
        - mount_path: /etc/hypershift-kubeconfig
          name: azure-hypershift-ci
          namespace: test-credentials
      from_image:
        namespace: ocp
        name: "4.16"
        tag: hypershift-operator
      grace_period: 1m0s
      resources:
        requests:
          cpu: 100m
      timeout: 25m0s