ref:
  as: hypershift-review-agent-process
  from: claude-ai-helpers
  commands: hypershift-review-agent-process-commands.sh
  env:
  - name: CLAUDE_CODE_USE_VERTEX
    default: "1"
    documentation: |-
      Enable Vertex AI for Claude Code.
  - name: CLOUD_ML_REGION
    default: "us-east5"
    documentation: |-
      Google Cloud region for Vertex AI.
  - name: ANTHROPIC_VERTEX_PROJECT_ID
    default: "itpc-gcp-hybrid-pe-eng-claude"
    documentation: |-
      Google Cloud project ID for Vertex AI authentication.
  - name: GOOGLE_APPLICATION_CREDENTIALS
    default: "/var/run/claude-code-service-account/claude-prow"
    documentation: |-
      Path to the Google Cloud service account JSON key file for Vertex AI authentication.
  - name: REVIEW_AGENT_MAX_PRS
    default: "10"
    documentation: |-
      Maximum number of PRs to process per run. Defaults to 10 for batch processing.
  - name: REVIEW_AGENT_BATCH_ONLY
    default: ""
    documentation: |-
      When set to "true", forces batch mode and ignores PULL_NUMBER.
      Use this for periodic jobs to prevent rehearsal failures when
      PULL_NUMBER refers to a release repo PR instead of a HyperShift PR.
  - name: CLAUDE_MODEL
    default: "claude-opus-4-5"
    documentation: |-
      Claude model to use for processing PR review comments.
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
  credentials:
  - namespace: test-credentials
    name: hypershift-team-claude-prow
    mount_path: /var/run/claude-code-service-account
  documentation: |-
    Process step for the HyperShift Review Agent periodic job.
    This step:
    - Queries GitHub for PRs created by the jira-agent (from hypershift-community fork)
    - Filters for PRs with unresolved review threads
    - For each PR, runs the /utils:address-reviews command non-interactively
    - Pushes changes back to the fork branch
    - Uses Vertex AI for Claude authentication via GCP service account
