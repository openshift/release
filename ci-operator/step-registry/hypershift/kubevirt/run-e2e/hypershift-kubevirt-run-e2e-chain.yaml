chain:
  as: hypershift-kubevirt-run-e2e
  steps:
  - as: run-e2e
    cli: latest
    commands: |-
        # compile the e2e tests
        make e2e

        # TODO Start
        # remove this once the bz is resolved
        # WORKAROUND FOR https://bugzilla.redhat.com/show_bug.cgi?id=2182453
        export OVS_FIX_SCRIPT=/tmp/ovs-fix-script.sh
        cat << EOF > $OVS_FIX_SCRIPT
        #!/bin/bash
        while true
        do
            echo "ovs fix script sleeping 3 minutes"
            sleep 180
            echo "ovs fix script awakes"
            export GUEST_KUBECONFIG=/tmp/guest-kubeconfig
            bin/hypershift create kubeconfig > \$GUEST_KUBECONFIG
            for node in \$(oc --kubeconfig \$GUEST_KUBECONFIG get nodes --no-headers | awk '{print \$1}'); do
                echo "restarting ovs-configuration service for node \$node"
                oc --kubeconfig \$GUEST_KUBECONFIG debug node/\$node -- chroot /host /bin/bash -c "/usr/bin/systemctl start ovs-configuration.service"
                echo "Result \$?"
                sleep 10
                oc --kubeconfig \$GUEST_KUBECONFIG debug node/\$node -- chroot /host /bin/bash -c "/usr/bin/systemctl status ovs-configuration.service"
            done
        done
        EOF

        chmod 755 $OVS_FIX_SCRIPT
        # start this in the background as a workaround for the ovs issue
        $OVS_FIX_SCRIPT &
        # TODO END

        # run the test
        bin/test-e2e \
                  --test.v \
                  --test.timeout=0 \
                  --test.run='^TestCreateCluster$' \
                  --e2e.node-pool-replicas=2 \
                  --e2e.kubevirt-node-memory="6Gi" \
                  --e2e.platform="KubeVirt" \
                  --e2e.latest-release-image=${OCP_IMAGE_LATEST} \
                  --e2e.previous-release-image=${OCP_IMAGE_PREVIOUS} \
                  --e2e.pull-secret-file=/etc/ci-pull-credentials/.dockerconfigjson

    credentials:
      - mount_path: /etc/ci-pull-credentials
        name: ci-pull-credentials
        namespace: test-credentials
    dependencies:
      - env: OCP_IMAGE_LATEST
        name: release:latest
      - env: OCP_IMAGE_PREVIOUS
        name: release:hosted-ocp-previous
      - env: CI_HYPERSHIFT_OPERATOR
        name: pipeline:hypershift-operator
    env:
      - default: ${SHARED_DIR}/management_cluster_kubeconfig
        name: KUBECONFIG
    from: test-bin
    grace_period: 30m0s
    resources:
      requests:
        cpu: 100m
        memory: 100Mi
    timeout: 1h0m0s

