workflow:
  as: hypershift-kubevirt-baremetalds-conformance-calico-version-skew
  documentation: |-
    Executes tests against a new ephemeral HyperShift cluster with Tigera Calico CNI
    and version skew between management (4.20) and hosted cluster (4.18).

    This workflow validates both functionality and ANSSI BP-028 kernel-level isolation
    requirements when running hosted clusters with version skew. The kernel isolation
    check proves that management and guest clusters run separate kernel instances,
    demonstrating true VM-level isolation for multi-tenant security.

    **Version Skew Configuration:**
    - Management cluster: OCP 4.20 (from release:latest)
    - Hosted cluster: OCP 4.18 (from release:latest-4-18)
    - Skew: y-2 (maximum allowed for even releases per OCPSTRAT-1707)

    **Testing Coverage:**
    1. KubeVirt VM isolation with version skew
    2. Kernel-level isolation validation (different boot IDs)
    3. Calico CNI functionality across versions
    4. Kubernetes conformance with version skew

    Learn more about HyperShift here: https://github.com/openshift/hypershift
    Track HyperShift's development here: https://issues.redhat.com/projects/HOSTEDCP

    **Related Jira:**
    - OCPSTRAT-2217: VM-level and Hosted Cluster Isolation levels for HCP
    - OCPSTRAT-1707: Align HCP NodePool minor-version skew limits
  steps:
    post:
    - chain: hypershift-dump
    - chain: gather-core-dump
    - chain: hypershift-kubevirt-destroy
    - chain: baremetalds-ofcir-post
    test:
    - ref: hypershift-kubevirt-check-kernel-isolation
    - chain: hypershift-conformance
    pre:
    - chain: baremetalds-ofcir-pre
    - ref: enable-qe-catalogsource
    - ref: deploy-konflux-operator
    - chain: hypershift-kubevirt-baremetalds-lvm
    - chain: hypershift-kubevirt-baremetalds-metallb
    - chain: hypershift-kubevirt-baremetalds-odf
    - ref: hypershift-kubevirt-install
    - ref: hypershift-install
    - ref: hypershift-kubevirt-create
    - ref: hypershift-kubevirt-baremetalds-proxy
    - ref: cucushift-hypershift-extended-calico
    - ref: cucushift-hypershift-extended-calico-health-check
    env:
      HYPERSHIFT_NETWORK_TYPE: "Other"
      KONFLUX_DEPLOY_OPERATORS: "false"
      KONFLUX_TARGET_OPERATORS: metallb,local-storage
      CLUSTERTYPE: host_384gb_el9
      METALLB_OPERATOR_SUB_SOURCE: qe-app-registry
      LOCAL_STORAGE_OPERATOR_SUB_SOURCE: qe-app-registry
      LVM_OPERATOR_SUB_SOURCE: lvm-catalogsource
      LVM_OPERATOR_SUB_INSTALL_NAMESPACE: openshift-lvm-storage
      ODF_OPERATOR_SUB_SOURCE: redhat-operators-v4-18
      ETCD_STORAGE_CLASS: lvms-vg1
      TEST_SKIPS: The default cluster RBAC policy should have correct RBAC rules\|
        Prometheus \[apigroup:image.openshift.io\] when installed on the cluster should
        provide named network metrics\| Unidling \[apigroup:apps.openshift.io\]\[apigroup:route.openshift.io\]
        should work with UDP\| Unidling with Deployments \[apigroup:route.openshift.io\]
        should work with TCP (when fully idled)\| Unidling \[apigroup:apps.openshift.io\]\[apigroup:route.openshift.io\]
        should work with TCP (when fully idled)\| Unidling with Deployments \[apigroup:route.openshift.io\]
        should work with UDP\|\[Feature:tuning\]\|\[Feature:bond\]\|\[Feature:vlan\]\|StatefulSet Basic\|
        StatefulSet Non-retain\|\[OCPFeatureGate:RouteExternalCertificate\]\|
        migration when running openshift cluster on KubeVirt virtual machines and live migrate hosted control plane
      DEVSCRIPTS_CONFIG: |
        IP_STACK=v4
        NETWORK_TYPE=OVNKubernetes
        NUM_WORKERS=0
        NUM_MASTERS=3
        MASTER_VCPU=16
        MASTER_MEMORY=81920
        VM_EXTRADISKS=true
        VM_EXTRADISKS_LIST="vda vdb"
        VM_EXTRADISKS_SIZE=250G
