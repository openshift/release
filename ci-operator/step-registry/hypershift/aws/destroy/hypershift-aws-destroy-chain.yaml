chain:
  as: hypershift-aws-destroy
  steps:
  - as: destroy
    cli: latest
    env:
    - name: HYPERSHIFT_BASE_DOMAIN
      default: ""
      documentation: "The cluster's FQDN will be a subdomain of the base domain."
    - name: HYPERSHIFT_AWS_REGION
      default: "us-east-1"
      documentation: |
        Specifies the AWS region for the cluster. If intentionally left as an empty string, 
        the region defaults to that of the management cluster.
    - name: HYPERSHIFT_GUEST_INFRA_OCP_ACCOUNT
      default: "false"
      documentation: "Whether to use the generic CI account or the HyperShift OSD account for the guest clusters infra. For the infra created for the clusters. E.g. For cluster-bot we use the generic CI account"
    - name: HYPERSHIFT_HC_NUMBER
      default: "1"
      documentation: "If set to greater than one, it would destroy multiple hosted clusters"
    commands: |-
      set -exuo pipefail
      
      AWS_GUEST_INFRA_CREDENTIALS_FILE="/etc/hypershift-ci-jobs-awscreds/credentials"
      DEFAULT_BASE_DOMAIN=ci.hypershift.devcluster.openshift.com
      
      if [[ $HYPERSHIFT_GUEST_INFRA_OCP_ACCOUNT == "true" ]]; then
        AWS_GUEST_INFRA_CREDENTIALS_FILE="${CLUSTER_PROFILE_DIR}/.awscred"
        DEFAULT_BASE_DOMAIN=origin-ci-int-aws.dev.rhcloud.com
      fi
      DOMAIN=${HYPERSHIFT_BASE_DOMAIN:-$DEFAULT_BASE_DOMAIN}
      HC_REGION=${HYPERSHIFT_AWS_REGION:-$LEASED_RESOURCE}
      
      HC_COUNT=$HYPERSHIFT_HC_NUMBER
      BASE_CLUSTER_NAME="$(echo -n $PROW_JOB_ID|sha256sum|cut -c-20)"
      for ((index = 1; index <= HC_COUNT; index++)); do
        if [[ $index -gt 1 ]]; then
          CLUSTER_NAME="${BASE_CLUSTER_NAME}${index}"
        else
          CLUSTER_NAME="${BASE_CLUSTER_NAME}"
        fi
        echo "$(date) Deleting HyperShift cluster ${CLUSTER_NAME}"
        bin/hypershift destroy cluster aws \
          --aws-creds=${AWS_GUEST_INFRA_CREDENTIALS_FILE}  \
          --name ${CLUSTER_NAME} \
          --region ${HC_REGION} \
          --base-domain ${DOMAIN} \
          --cluster-grace-period 40m
        echo "$(date) Finished deleting cluster"
      done
    from: hypershift-operator
    grace_period: 5m0s
    resources:
      requests:
        cpu: 100m
        memory: 100Mi
    timeout: 180m0s
    credentials:
    - mount_path: /etc/hypershift-ci-jobs-awscreds
      name: hypershift-ci-jobs-awscreds
      namespace: test-credentials
