ref:
  as: servicemesh-istio-unit-gencheck-eks
  commands: servicemesh-istio-unit-gencheck-eks-commands.sh
  credentials:
  - mount_path: /tmp/secrets
    name: cluster-secrets-ossm-aws
    namespace: ci
  from_image:
    name: mapt
    namespace: ci
    tag: v0.9.6
  grace_period: 20m
  resources:
    requests:
      cpu: "4"
      memory: 4Gi
    limits:
      memory: 16Gi
  documentation: |-
    Executes both OSSM Istio unit and gencheck tests in a single privileged pod running in the EKS cluster created by the MAPT workflow.
    This combines both test suites to optimize cluster utilization and reduce infrastructure costs.

    The step runs in the MAPT image (which has AWS CLI pre-installed) to solve EKS authentication issues.
    This eliminates the need to install AWS CLI since the kubeconfig generated by MAPT requires AWS CLI for EKS token authentication.

    The step:
    1. Installs kubectl for EKS cluster management
    2. Configures AWS credentials for EKS authentication (AWS CLI already available in MAPT image)
    3. Verifies EKS cluster connectivity with security-conscious debugging
    4. Creates privileged namespace and pod with kernel module and Docker socket access
    5. Copies source code to the pod using kubectl cp
    6. Runs unit tests with BUILD_WITH_CONTAINER=0
    7. Runs gencheck tests with BUILD_WITH_CONTAINER=0
    8. Collects test artifacts and logs from both test suites
    9. Cleans up the privileged pod with proper error handling

    Requires kubeconfig at ${SHARED_DIR}/kubeconfig from the preceding MAPT create step.
    Uses AWS credentials from the existing vault system (cluster-secrets-ossm-aws) for EKS authentication.