chain:
  as: kueue-operator-test-e2e-upstream
  steps:
  - ref: cert-manager-install-operator
  - as: kueue-operator-jobset-install-operator
    cli: latest
    commands: |
      CURRENT_BRANCH=$(git branch --show-current)
      if [[ "$CURRENT_BRANCH" == "release-1.0" || "$CURRENT_BRANCH" == "release-1.1" ]]; then
          echo "Skipping step due to JobSet not being supported in ${CURRENT_BRANCH}"
          exit 0
      fi
      make install-jobset-operator
    from: kueue-operator-src
    resources:
      requests:
        cpu: 300m
        memory: 500Mi
  - as: kueue-operator-lws-install-operator
    cli: latest
    commands: |
      CURRENT_BRANCH=$(git branch --show-current)
      if [[ "$CURRENT_BRANCH" == "release-1.0" || "$CURRENT_BRANCH" == "release-1.1" ]]; then
          echo "Skipping step due to LeaderWorkerSet not being supported in ${CURRENT_BRANCH}"
          exit 0
      fi
      make install-lws-operator
    from: kueue-operator-src
    resources:
      requests:
        cpu: 300m
        memory: 500Mi
  - as: install-operator
    cli: latest
    dependencies:
    - name: kueue-operator-bundle
      env: OO_BUNDLE
    commands: |
      echo "Installing operator from bundle: ${OO_BUNDLE}"
      oc create namespace openshift-kueue-operator || true
      oc label ns openshift-kueue-operator openshift.io/cluster-monitoring=true security.openshift.io/scc.podSecurityLabelSync=true --overwrite
      cd /tmp
      operator-sdk run bundle --timeout=10m -n openshift-kueue-operator "$OO_BUNDLE" --security-context-config=restricted
    from: cli-operator-sdk
    resources:
      requests:
        cpu: 300m
        memory: 300Mi
  - as: e2e-kueue-upstream
    cli: latest
    commands: |
      make e2e-upstream-test
    from: kueue-operator-src
    resources:
      requests:
        cpu: "4"
        memory: "4Gi"
  documentation: |-
    This chain runs the upstream e2e test suites for The Kueue operator.
