workflow:
  as: aws-neuron-operator-conditional-e2e-rosa
  steps:
    env:
      HOSTED_CP: "true"
      ENABLE_BYOVPC: "true"
      ZONES_COUNT: "1"
      COMPUTE_MACHINE_TYPE: "inf2.xlarge"
      REPLICAS: "2"
      OCM_LOGIN_ENV: "production"
    pre:
    # VPC and tagging setup
    - ref: aws-provision-vpc-shared
    - ref: aws-provision-tags-for-byo-vpc-ocm-pre
    # OIDC and account roles setup
    - chain: rosa-sts-oidc-config-create
    # Custom cluster provision step that handles "zero egress" CLI bug
    - ref: aws-neuron-operator-rosa-cluster-provision
    - ref: rosa-cluster-wait-ready-cluster
    - ref: rosa-cluster-notify-error
    - ref: rosa-conf-idp-htpasswd
    - ref: rosa-cluster-wait-ready-operators
    - ref: aws-provision-tags-for-byo-vpc
    # Additional configuration
    - ref: osd-ccs-conf-idp-htpasswd-multi-users
    - ref: rosa-cluster-wait-ready-nodes
    test:
    - ref: aws-neuron-operator-test
    post:
    - chain: rosa-aws-sts-hcp-deprovision
  documentation: |-
    This workflow provisions a ROSA HCP cluster with 2x AWS Inferentia (inf2.xlarge)
    compute nodes, then runs the AWS Neuron operator E2E tests conditionally
    based on kernel changes.

    Uses a custom provision step to work around the ROSA CLI "zero egress" bug
    where the CLI returns exit code 1 after successfully creating the cluster.
