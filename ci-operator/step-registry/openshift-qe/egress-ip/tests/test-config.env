# Enhanced Egress IP Test Configuration
# This file contains configurable parameters for egress IP resilience testing

# Test Configuration
EIP_NAME="${EIP_NAME:-egressip1}"
POD_KILL_RETRIES="${POD_KILL_RETRIES:-10}"
REBOOT_RETRIES="${REBOOT_RETRIES:-5}"

# Timeout Configuration (all values in seconds)
# Scale these based on cluster size and expected performance

# Pod readiness timeout - how long to wait for pods to become ready
POD_READY_TIMEOUT="${POD_READY_TIMEOUT:-300}"          # 5 minutes

# Node readiness timeout - how long to wait for nodes to become ready after reboot  
NODE_READY_TIMEOUT="${NODE_READY_TIMEOUT:-450}"        # 7.5 minutes

# Migration timeout - how long to wait for egress IP migration between nodes
MIGRATION_TIMEOUT="${MIGRATION_TIMEOUT:-900}"          # 15 minutes (increased for large clusters)

# OVN stabilization wait - how long to wait for OVN to stabilize after changes
OVN_STABILIZATION_WAIT="${OVN_STABILIZATION_WAIT:-30}" # 30 seconds

# Workload readiness timeout - how long to wait for test workload to be ready
WORKLOAD_READY_TIMEOUT="${WORKLOAD_READY_TIMEOUT:-120}" # 2 minutes

# Cleanup timeout - how long to wait for resource cleanup
CLEANUP_TIMEOUT="${CLEANUP_TIMEOUT:-120}"               # 2 minutes

# Network Configuration
# External targets for egress testing (make configurable for restricted environments)
EGRESS_TEST_TARGET1="${EGRESS_TEST_TARGET1:-google.com}"
EGRESS_TEST_TARGET2="${EGRESS_TEST_TARGET2:-redhat.com}"

# Use internal cluster targets in restricted environments
# EGRESS_TEST_TARGET1="kubernetes.default.svc.cluster.local"
# EGRESS_TEST_TARGET2="openshift.default.svc.cluster.local"

# Logging Configuration
LOG_LEVEL="${LOG_LEVEL:-INFO}"                         # DEBUG, INFO, WARNING, ERROR
VERBOSE_LOGGING="${VERBOSE_LOGGING:-false}"            # Enable verbose debug logging
STRUCTURED_LOGGING="${STRUCTURED_LOGGING:-false}"     # Enable JSON structured logging

# Performance Tuning
# Adjust these based on cluster performance characteristics

# How often to check for status changes (in seconds)
POLL_INTERVAL="${POLL_INTERVAL:-5}"

# How often to log progress during long operations (in seconds)  
PROGRESS_INTERVAL="${PROGRESS_INTERVAL:-30}"

# Number of retries for transient operations
RETRY_COUNT="${RETRY_COUNT:-3}"

# Wait time between retries (in seconds)
RETRY_DELAY="${RETRY_DELAY:-5}"

# OVN Database Timeouts
OVN_DB_TIMEOUT="${OVN_DB_TIMEOUT:-15}"                # OVN database operation timeout
OVN_COMMAND_TIMEOUT="${OVN_COMMAND_TIMEOUT:-30}"      # OVN command execution timeout

# Security Configuration
VALIDATE_NODE_NAMES="${VALIDATE_NODE_NAMES:-true}"     # Enable node name validation
ALLOW_FORCED_CLEANUP="${ALLOW_FORCED_CLEANUP:-true}"   # Allow forced resource cleanup

# Test Behavior Configuration
CONTINUE_ON_FAILURE="${CONTINUE_ON_FAILURE:-true}"     # Continue testing even if some tests fail
COLLECT_DEBUG_ON_FAILURE="${COLLECT_DEBUG_ON_FAILURE:-true}" # Collect additional debug info on failures
SKIP_EXTERNAL_CONNECTIVITY="${SKIP_EXTERNAL_CONNECTIVITY:-false}" # Skip external connectivity tests

# Artifact Collection
COLLECT_ENHANCED_METRICS="${COLLECT_ENHANCED_METRICS:-true}"     # Collect detailed OVN metrics
COMPRESS_ARTIFACTS="${COMPRESS_ARTIFACTS:-false}"                # Compress collected artifacts
MAX_LOG_SIZE_MB="${MAX_LOG_SIZE_MB:-100}"                       # Maximum log file size in MB

# Advanced Configuration
# These should only be modified for specific testing scenarios

# Enable experimental features
ENABLE_EXPERIMENTAL_FEATURES="${ENABLE_EXPERIMENTAL_FEATURES:-false}"

# Use alternative reboot methods if standard methods fail
ENABLE_ALTERNATIVE_REBOOT="${ENABLE_ALTERNATIVE_REBOOT:-true}"

# Maximum number of concurrent operations
MAX_CONCURRENT_OPS="${MAX_CONCURRENT_OPS:-5}"

# Environment-specific overrides
# Uncomment and modify as needed for your environment

# For CI/CD environments
if [[ "${CI:-false}" == "true" ]]; then
    # Increase timeouts for CI environments
    POD_READY_TIMEOUT=$((POD_READY_TIMEOUT * 2))
    NODE_READY_TIMEOUT=$((NODE_READY_TIMEOUT * 2))
    MIGRATION_TIMEOUT=$((MIGRATION_TIMEOUT * 2))
    
    # Use internal targets in CI
    EGRESS_TEST_TARGET1="kubernetes.default.svc.cluster.local"
    EGRESS_TEST_TARGET2="openshift.default.svc.cluster.local"
    
    # Enable verbose logging in CI
    VERBOSE_LOGGING="true"
    COLLECT_DEBUG_ON_FAILURE="true"
fi

# For development environments  
if [[ "${DEVELOPMENT:-false}" == "true" ]]; then
    # Shorter timeouts for faster iteration
    POD_READY_TIMEOUT=180
    WORKLOAD_READY_TIMEOUT=60
    OVN_STABILIZATION_WAIT=15
    
    # Enable debug logging
    LOG_LEVEL="DEBUG"
    VERBOSE_LOGGING="true"
fi

# For large cluster testing
if [[ "${LARGE_CLUSTER:-false}" == "true" ]]; then
    # Significantly increased timeouts
    POD_READY_TIMEOUT=600        # 10 minutes
    NODE_READY_TIMEOUT=900       # 15 minutes  
    MIGRATION_TIMEOUT=1800       # 30 minutes
    OVN_STABILIZATION_WAIT=60    # 1 minute
    WORKLOAD_READY_TIMEOUT=300   # 5 minutes
    
    # Reduce polling frequency to lower load
    POLL_INTERVAL=10
    PROGRESS_INTERVAL=60
fi

# Validation
validate_config() {
    local errors=0
    
    # Validate timeout values are positive integers
    local timeout_vars=("POD_READY_TIMEOUT" "NODE_READY_TIMEOUT" "MIGRATION_TIMEOUT" 
                        "OVN_STABILIZATION_WAIT" "WORKLOAD_READY_TIMEOUT" "CLEANUP_TIMEOUT")
    
    for var in "${timeout_vars[@]}"; do
        local value="${!var}"
        if ! [[ "$value" =~ ^[1-9][0-9]*$ ]]; then
            echo "ERROR: $var must be a positive integer, got: $value" >&2
            ((errors++))
        fi
    done
    
    # Validate retry count
    if ! [[ "$RETRY_COUNT" =~ ^[1-9][0-9]*$ ]]; then
        echo "ERROR: RETRY_COUNT must be a positive integer, got: $RETRY_COUNT" >&2
        ((errors++))
    fi
    
    # Validate log level
    case "$LOG_LEVEL" in
        DEBUG|INFO|WARNING|ERROR) ;;
        *) echo "ERROR: LOG_LEVEL must be DEBUG, INFO, WARNING, or ERROR, got: $LOG_LEVEL" >&2; ((errors++)) ;;
    esac
    
    return $errors
}