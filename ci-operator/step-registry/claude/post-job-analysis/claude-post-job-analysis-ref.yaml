ref:
  as: claude-post-job-analysis
  from: claude-ai-helpers
  env:
  - name: CLAUDE_CODE_USE_VERTEX
    default: "1"
    documentation: |-
      Enable Vertex AI for Claude Code.
  - name: CLOUD_ML_REGION
    default: "us-east5"
    documentation: |-
      Google Cloud region for Vertex AI.
  - name: ANTHROPIC_VERTEX_PROJECT_ID
    default: "openshift-ci-data-analysis"
    documentation: |-
      Google Cloud project ID for Vertex AI authentication.
  - name: GOOGLE_APPLICATION_CREDENTIALS
    default: "/var/run/claude-code-service-account/json"
    documentation: |-
      Path to the Google Cloud service account JSON key file for Vertex AI authentication.
  credentials:
  - namespace: test-credentials
    name: ci-claude-code-service-account
    mount_path: /var/run/claude-code-service-account
  commands: claude-post-job-analysis-commands.sh
  grace_period: 1m0s
  resources:
    requests:
      cpu: 1000m
      memory: 1Gi
  documentation: |-
    This step analyzes CI job failures by examining artifacts in $ARTIFACT_DIR including
    finished.json to determine which steps failed, JUnit test results for test failures,
    and various logs (must-gather, gather-extra, logbundle) to diagnose the root cause.

    The analysis is performed locally using artifacts already collected in $ARTIFACT_DIR
    without requiring external access to GCS buckets.
  timeout: 15m
