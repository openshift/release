ref:
  as: redhat-appstudio-prow-failure-analysis
  best_effort: true
  timeout: 30m0s
  from_image:
    namespace: devprod
    name: prow-failure-analysis
    tag: latest
  commands: redhat-appstudio-prow-failure-analysis-commands.sh
  credentials:
  - mount_path: /tmp/secrets/failure-analysis
    name: devprod-failure-analysis
    namespace: test-credentials
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
  env:
  - name: LLM_PROVIDER
    default: "gemini"
    documentation: |-
      The LLM provider to use for analysis. Defaults to gemini (Google Gemini).
  - name: LLM_MODEL
    default: "gemini-2.5-flash-lite"
    documentation: |-
      The LLM model to use for analysis. Defaults to gemini-2.5-flash-lite.
  - name: LLM_API_KEY_PATH
    default: "/tmp/secrets/failure-analysis/llm_key"
    documentation: |-
      Path to the LLM API key file. Defaults to the mounted devprod-failure-analysis secret.
  - name: LLM_BASE_URL
    default: ""
    documentation: |-
      Optional base URL for the LLM API. Use this for custom endpoints or self-hosted models.
  - name: GITHUB_TOKEN_PATH
    default: "/tmp/secrets/failure-analysis/github_token"
    documentation: |-
      Path to the GitHub token file for posting PR comments.
  - name: POST_COMMENT
    default: "true"
    documentation: |-
      Set to "true" to post the analysis results as a comment on the GitHub PR.
  - name: GCS_BUCKET
    default: "test-platform-results"
    documentation: |-
      The GCS bucket containing Prow job artifacts.
  - name: GCS_CREDS_PATH
    default: ""
    documentation: |-
      Optional path to GCS credentials file. If not specified, uses default application credentials or anonymous access for public buckets.
  - name: IGNORED_STEPS
    default: "appstudio-e2e-tests/*-report"
    documentation: |-
      Comma-separated list of step name patterns to ignore during analysis. Defaults to ignoring AppStudio report steps.
  - name: INCLUDED_ARTIFACTS
    default: "appstudio-e2e-tests/redhat-appstudio-gather/artifacts/*"
    documentation: |-
      Glob patterns for additional artifacts to include in analysis. Defaults to AppStudio gather artifacts.
  - name: CORDON_DEVICE
    default: "cpu"
    documentation: |-
      Device to use for semantic log preprocessing (cpu, cuda, mps). Defaults to cpu.
  - name: CORDON_BACKEND
    default: "remote"
    documentation: |-
      Backend to use for embeddings. Defaults to "remote" for API-based embeddings.
  - name: CORDON_MODEL_NAME
    default: "google/gemini-embedding-001"
    documentation: |-
      Model name for embeddings. Defaults to Google's embedding model.
  - name: CORDON_API_KEY_PATH
    default: "/tmp/secrets/failure-analysis/llm_key"
    documentation: |-
      Path to the embedding API key. Defaults to the same key as the LLM.
  - name: CORDON_ENDPOINT
    default: ""
    documentation: |-
      Optional custom endpoint URL for remote embedding API. Only needed for custom/self-hosted OpenAI-compatible endpoints.
  - name: CORDON_BATCH_SIZE
    default: "32"
    documentation: |-
      Batch size for embedding operations. Higher values = faster processing but more memory. Default is 32.
  - name: VERBOSE
    default: "false"
    documentation: |-
      Set to "true" to enable verbose logging output.
  documentation: |-
    Usage in CI config:
    ```yaml
    tests:
    - as: my-test
      steps:
        post:
        - ref: redhat-appstudio-prow-failure-analysis
        test:
        - ref: my-test-step
        workflow: redhat-appstudio-claim
    ```

    To override defaults, set env vars at the steps level:
    ```yaml
    steps:
      env:
        LLM_MODEL: gemini-1.5-pro
        POST_COMMENT: "false"
        VERBOSE: "true"
      post:
      - ref: redhat-appstudio-prow-failure-analysis
    ```

    For more information, see: https://github.com/redhat-community-ai-tools/prow-failure-analysis

