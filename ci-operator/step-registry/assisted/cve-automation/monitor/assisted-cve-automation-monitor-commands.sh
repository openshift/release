#!/bin/bash

set -o nounset
set -o errexit
set -o pipefail
set -x

echo "************ assisted CVE automation monitor command ************"

# Load secrets from mounted paths
GITHUB_APP_ID=$(cat "/var/run/vault/cve-automation-github-app/github_app_id")
GITHUB_APP_INSTALLATION_ID=$(cat "/var/run/vault/cve-automation-github-app/github_app_installation_id")
GITHUB_APP_PRIVATE_KEY_PATH="/var/run/vault/cve-automation-github-app/github_app_private_key.pem"
JIRA_API_TOKEN=$(cat "/var/run/vault/cve-automation-jira/jira_api_token")

export GITHUB_APP_ID
export GITHUB_APP_INSTALLATION_ID
export GITHUB_APP_PRIVATE_KEY=$(cat "$GITHUB_APP_PRIVATE_KEY_PATH")
export JIRA_API_TOKEN

# Validate required credentials
if [[ -z "${GITHUB_APP_ID:-}" || -z "${GITHUB_APP_INSTALLATION_ID:-}" || -z "${GITHUB_APP_PRIVATE_KEY_PATH:-}" ]]; then
    echo "ERROR: GitHub App environment variables must be set for CVE automation"
    echo "Required: GITHUB_APP_ID, GITHUB_APP_INSTALLATION_ID, GITHUB_APP_PRIVATE_KEY_PATH"
    exit 1
fi

if [[ -z "${JIRA_API_TOKEN:-}" ]]; then
    echo "ERROR: JIRA_API_TOKEN must be set"
    exit 1
fi

# Get GitHub App token for authentication
export GH_TOKEN=$(python github_auth.py)

# Install Python dependencies
uv pip install --system -r requirements.txt

# Run PR monitoring
python pr_monitor.py

# Commit and push changes
git add cves.yaml
git commit -m "Update CVE monitoring results - $(date '+%Y-%m-%d %H:%M:%S')"
git push origin HEAD