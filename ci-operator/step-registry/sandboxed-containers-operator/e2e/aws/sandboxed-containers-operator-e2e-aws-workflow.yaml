workflow:
  as: sandboxed-containers-operator-e2e-aws
  steps:
    env:
      TEST_PARALLEL: 1
      COMPUTE_NODE_REPLICAS: 2
      CONTROL_PLANE_REPLICAS: 3
      SPOT_INSTANCES: "false"
      FORCE_SUCCESS_EXIT: "no"
      MUST_GATHER_IMAGE: "registry.redhat.io/openshift-sandboxed-containers/osc-must-gather-rhel9:latest"
      MUST_GATHER_TIMEOUT: "35m"
      ENABLE_MUST_GATHER: "true"
      MUST_GATHER_ON_FAILURE_ONLY: "true"
    pre:
    - chain: ipi-conf-aws
    - chain: aws-provision-iam-user-minimal-permission
    - ref: sandboxed-containers-operator-aws-region-override
    - chain: ipi-install
    - chain: sandboxed-containers-operator-pre
    post:
    - ref: sandboxed-containers-operator-gather-must-gather
    - ref: cucushift-installer-wait
    - as: sandboxed-containers-operator-delete-kataconfig
      cli: latest
      commands: |
        # Delete kataconfig if present
        if oc get crd kataconfigurations.kataconfiguration.openshift.io &>/dev/null; then
            oc get kataconfigurations.kataconfiguration.openshift.io -o name | while read cfg; do
                echo "Deleting $cfg"
                oc delete "$cfg" --wait
            done
        else
            echo "kataconfigurations.kataconfiguration.openshift.io not defined, skipping cleanup"
        fi
      from: upi-installer
      resources:
        requests:
          cpu: 100m
          memory: 200Mi
    - chain: ipi-aws-post
    test:
    - ref: openshift-extended-test
  documentation: |-
    This workflow run openshift-extented-test on an AWS cluster with
    the sandboxed containers deployed.
    AWS_REGION_OVERRIDE from sandboxed-containers-operator-aws-region-override
    defines the region to create the cluster in.
