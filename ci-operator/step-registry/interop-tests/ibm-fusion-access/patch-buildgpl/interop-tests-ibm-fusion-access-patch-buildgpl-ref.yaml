ref:
  as: interop-tests-ibm-fusion-access-patch-buildgpl
  from: cli
  commands: interop-tests-ibm-fusion-access-patch-buildgpl-commands.sh
  timeout: 20m0s
  resources:
    requests:
      cpu: 100m
      memory: 200Mi
  env:
  - name: STORAGE_SCALE_NAMESPACE
    documentation: The namespace for IBM Storage Scale resources
    default: "ibm-spectrum-scale"
  documentation: |-
    Patch buildgpl ConfigMap to fix RHCOS compatibility issues.
    
    IBM Storage Scale v5.2.3.1 manifests create a buildgpl ConfigMap with a broken
    script when KMM is not fully supported. The script has two critical bugs:
    
    1. Expects lxtrace files that don't exist: rsync fails with error code 23
    2. Checks if kernel module is loaded: lsmod fails (module loads in main container)
    
    This step waits for the buildgpl ConfigMap to be created by the IBM Storage Scale
    operator (after kernel header timeout, usually 7-10 minutes), then patches the
    script to:
    - Create kernel-specific lxtrace file that init container expects
    - Remove broken lsmod check that fails during init
    - Handle missing source files gracefully
    
    The operator creates buildgpl as a fallback when:
    - Kernel headers are not available on host (RHCOS doesn't have them)
    - KMM Module CRs are not being used (v5.2.3.1 limitation)
    
    Workaround for: IBM Storage Scale v5.2.3.1 manifests on RHCOS
    Future: Remove this step when using versions with proper KMM/RHCOS support

