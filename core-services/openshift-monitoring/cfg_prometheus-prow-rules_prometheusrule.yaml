apiVersion: v1
kind: List
items:
- apiVersion: monitoring.coreos.com/v1
  kind: PrometheusRule
  metadata:
    labels:
      prometheus: k8s
      role: alert-rules
    name: prometheus-prow-rules
    namespace: openshift-monitoring
  spec:
    groups:
    - name: prow.rules
      rules:
      - alert: OverCPURequests
        expr: |
          100 * (label_replace(pod_name:container_cpu_usage:sum, "pod", "$1", "pod_name", "(.*)") 
          * on (pod) label_replace(kube_pod_labels{pod!="",label_app="prow"}, "pod_name", "$1", "pod", "(.*)") 
          / sum(kube_pod_container_resource_requests_cpu_cores) by (pod)) > 150
        for: 5m
        labels:
          severity: critical
        annotations:
          message: Pod {{$labels.pod}} has over 150% CPU usage than initially requested. Pod {{$labels.pod}} has high CPU usage of {{ printf "%0.0f" $value }}%.

      - alert: OverMemoryRequests
        expr: |
          100 * (sum by(pod)(container_memory_working_set_bytes{namespace="ci",container_name="POD"} 
          * on (pod_name) group_left(pod) label_replace(kube_pod_labels{pod!="",label_app="prow"}, "pod_name", "$1", "pod", "(.*)"))
          / sum(kube_pod_container_resource_requests_memory_bytes) by (pod)) > 150
        for: 5m
        labels:
          severity: critical
        annotations:
          message: Pod {{$labels.pod}} has over 150% memory usage than initially requested. Pod {{$labels.pod}} has high memory usage {{ $ value | humanize1024 }}B.
    - name: ci-op.rules
      rules:
      - alert: OverCPURequests
        expr: |
         100 * (sum by(pod)(label_join(pod_name:container_cpu_usage:sum, "pod", "", "pod_name")) * on(pod) group_right(label_component) label_replace(kube_pod_labels {namespace=~"ci-op-.*", label_ci_openshift_io_refs_org!="", label_ci_openshift_io_refs_repo!="", label_ci_openshift_io_refs_branch!=""}, "pod", "$1", "pod", "(.*)")) / on (pod) group_left sum(label_replace(kube_pod_container_resource_requests_cpu_cores, "pod", "$1", "pod", "(.*)")) by (pod) > 150
        for: 5m
        labels:
          severity: critical
        annotations:
          message: '{{$labels.label_ci_openshift_io_refs_org}}/{{$labels.label_ci_openshift_io_refs_repo}}@{{$labels.label_ci_openshift_io_refs_branch}} Pod {{$labels.pod}} in namespace {{$labels.namespace}} has over 150% CPU usage than initially requested. Ci-Op Pod {{$labels.pod}} in namespace {{$labels.namespace}} has high CPU usage {{ printf "%0.0f" $value }}.'

      - alert: OverMemoryRequests
        expr: |
          100 * (sum by(pod)(label_join(container_memory_working_set_bytes, "pod", "", "pod_name")) * on(pod) group_right(label_component) label_replace(kube_pod_labels {namespace=~"ci-op-.*", label_ci_openshift_io_refs_org!="", label_ci_openshift_io_refs_repo!="", label_ci_openshift_io_refs_branch!=""}, "pod", "$1", "pod", "(.*)")) / on (pod) group_left sum(label_replace(kube_pod_container_resource_requests_memory_bytes, "pod", "$1", "pod", "(.*)")) by (pod) > 150
        for: 5m
        labels:
          severity: critical
        annotations:
          message: '{{$labels.label_ci_openshift_io_refs_org}}/{{$labels.label_ci_openshift_io_refs_repo}}@{{$labels.label_ci_openshift_io_refs_branch}} Pod {{$labels.pod}} in namespace {{$labels.namespace}} has over 150% memory usage than initially requested. Ci-Op Pod {{$labels.pod}} in namespace {{$labels.namespace}} has high memory usage {{ $ value | humanize1024 }}B.'
