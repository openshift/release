apiVersion: apps/v1
kind: Deployment
metadata:
  name: dashboard
  namespace: ship-status
  labels:
    app: dashboard
  annotations:
    keel.sh/policy: force
    keel.sh/matchTag: "true"
    keel.sh/trigger: poll
    keel.sh/pollSchedule: "@every 5m"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dashboard
  template:
    metadata:
      labels:
        app: dashboard
    spec:
      serviceAccountName: ship-status
      initContainers:
      - name: git-sync-init
        command:
        - /git-sync
        args:
        - --repo=https://github.com/openshift/release.git
        - --ref=master
        - --root=/tmp/git-sync
        - --one-time=true
        - --depth=1
        - --link=release
        image: quay-proxy.ci.openshift.org/openshift/ci:ci_git-sync_v4.3.0
        volumeMounts:
        - name: release
          mountPath: /tmp/git-sync
      - name: db-migration
        image: quay-proxy.ci.openshift.org/openshift/ci:ship-status-dash_migrate_latest
        command: ["./migrate"]
        args:
          - "--dsn=$(DATABASE_DSN)"
        env:
          - name: DATABASE_DSN
            valueFrom:
              secretKeyRef:
                name: postgres
                key: dsn
      containers:
      - name: git-sync
        command:
        - /git-sync
        args:
        - --repo=https://github.com/openshift/release.git
        - --ref=master
        - --period=30s
        - --root=/tmp/git-sync
        - --max-failures=3
        - --link=release
        image: quay-proxy.ci.openshift.org/openshift/ci:ci_git-sync_v4.3.0
        volumeMounts:
        - name: release
          mountPath: /tmp/git-sync
        resources:
          requests:
            memory: "1Gi"
            cpu: "0.5"
      - name: oauth-proxy
        image: quay.io/openshift/origin-oauth-proxy:4.20
        args:
          - -provider=openshift
          - -http-address=:8443
          - -https-address=
          - -upstream=http://localhost:8080
          - -openshift-ca=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          - --cookie-secret-file=/etc/secrets/session_secret
          - --cookie-samesite=none
          - --cookie-secure=true
          - --cookie-domain=ship-status.ci.openshift.org
          - --skip-auth-preflight
          - --redirect-url=https://protected.ship-status.ci.openshift.org/oauth/callback
          - --client-id=system:serviceaccount:ship-status:ship-status
          - --client-secret-file=/var/run/secrets/kubernetes.io/serviceaccount/token
          - '--openshift-sar={"resource": "namespaces", "verb": "get"}'
          - '--openshift-delegate-urls={"/": {"resource": "namespaces", "verb": "get"}}'
          - --signature-key=sha256:$(HMAC_SECRET)
        ports:
        - containerPort: 8443
          name: http
        env:
        - name: HMAC_SECRET
          valueFrom:
            secretKeyRef:
              name: dashboard-hmac
              key: hmac
        readinessProbe:
          tcpSocket:
            port: 8443
        volumeMounts:
        - name: oauth-proxy-cookie-secret
          mountPath: /etc/secrets
          readOnly: true
        - name: hmac-secret
          mountPath: /etc/secrets/hmac-secret
          readOnly: true
      - name: dashboard
        image: quay-proxy.ci.openshift.org/openshift/ci:ship-status-dash_dashboard_latest
        command: ["./dashboard"]
        args:
          - "--config=/var/repo/release/core-services/ship-status/dashboard-config.yaml"
          - "--dsn=$(DATABASE_DSN)"
          - "--port=8080"
          - "--hmac-secret-file=/etc/secrets/hmac-secret/hmac"
          - "--cors-origin=https://ship-status.ci.openshift.org"
        ports:
          - containerPort: 8080
            protocol: TCP
        env:
          - name: DATABASE_DSN
            valueFrom:
              secretKeyRef:
                name: postgres
                key: dsn
        volumeMounts:
          - name: release
            mountPath: /var/repo
            readOnly: true
          - name: hmac-secret
            mountPath: /etc/secrets/hmac-secret
            readOnly: true
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 15
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
      volumes:
        - name: release
          emptyDir: {}
        - name: oauth-proxy-cookie-secret
          secret:
            secretName: oauth-proxy-cookie-secret
        - name: hmac-secret
          secret:
            secretName: dashboard-hmac
            items:
              - key: hmac
                path: hmac
